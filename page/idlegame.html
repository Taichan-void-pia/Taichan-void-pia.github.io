<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯¾ç­–ç‰ˆï¼‰</title>
<style>
  body{font-family:"Segoe UI",sans-serif;background:#111;color:#fff;text-align:center;margin:0;padding:20px}
  h1{color:#00e676;text-shadow:0 0 8px #00e676}
  .stats{margin:20px auto;padding:10px 20px;background:rgba(255,255,255,0.05);border-radius:12px;width:420px}
  .money{font-size:1.6em;color:#00e676;font-weight:bold}
  .formula{font-size:0.9em;color:#ccc;margin-top:4px}
  .upgrade{background:rgba(255,255,255,0.07);border-radius:10px;padding:12px;margin:10px auto;width:90%;max-width:520px;box-shadow:0 0 6px rgba(0,0,0,0.4)}
  .meter{background:rgba(255,255,255,0.1);border-radius:10px;height:18px;overflow:hidden;margin:8px 0}
  .fill{height:100%;background:linear-gradient(90deg,#00e676,#00bfa5);width:0%;transition:width 0.12s linear}
  button{background:linear-gradient(90deg,#00e676,#00bfa5);border:none;border-radius:6px;color:black;font-weight:bold;padding:6px 12px;cursor:pointer}
  .prestige{margin-top:14px;background:linear-gradient(90deg,#ffca28,#f57f17);border:none;border-radius:10px;padding:10px 18px;color:#000;font-weight:bold;cursor:pointer}
  .prestige:disabled{opacity:0.5;cursor:not-allowed}
  .small{font-size:0.9em;color:#ccc}
  .flex-row{display:flex;gap:8px;justify-content:center;align-items:center}
</style>
</head>
<body>
  <h1>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯¾ç­–ç‰ˆï¼‰</h1>

  <div class="stats">
    <div>æ‰€æŒé‡‘ï¼š<span class="money" id="money">0</span></div>
    <div>1ç§’ã‚ãŸã‚Šã®åå…¥ï¼š<span id="rate">0</span></div>
    <div class="formula" id="formula">(è¨ˆç®—å¼)</div>
    <div class="small">è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆï¼š<span id="prestigePoints">0</span>ã€€/ã€€è»¢ç”Ÿå€ç‡ï¼šÃ—<span id="prestigeMult">1</span></div>
  </div>

  <div id="upgradeContainer"></div>

  <div style="margin-top:12px;">
    <button id="prestigeBtn" class="prestige" onclick="doPrestige()">âœ¨ è»¢ç”Ÿã™ã‚‹ï¼ˆæ¡ä»¶: 1.8e308ï¼‰</button>
  </div>

<script>
/* ===========================
   å®šç¾©ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
   =========================== */
const upgradesTemplate = [
  { name:"åå…¥ã‚¢ãƒƒãƒ—", baseRate:1.0, rate:1.0, mult:0, speedMult:1.5, baseCost:10, level:0, progress:0 },
  { name:"åŠ¹ç‡ã‚¢ãƒƒãƒ—", baseRate:0.8, rate:0.8, mult:0, speedMult:1.4, baseCost:30, level:0, progress:0 },
  { name:"è‡ªå‹•è²©å£²æ©Ÿ", baseRate:0.6, rate:0.6, mult:0, speedMult:1.3, baseCost:100, level:0, progress:0 },
  { name:"éŠ€è¡ŒæŠ•è³‡", baseRate:0.4, rate:0.4, mult:0, speedMult:1.25, baseCost:500, level:0, progress:0 },
  { name:"AIç”Ÿæˆå·¥å ´", baseRate:0.2, rate:0.2, mult:0, speedMult:1.2, baseCost:2000, level:0, progress:0 },
];
function cloneTemplate(){ return JSON.parse(JSON.stringify(upgradesTemplate)); }

/* ===========================
   ã‚²ãƒ¼ãƒ çŠ¶æ…‹
   =========================== */
let money = 0;
let baseIncome = 1;
let upgrades = cloneTemplate();
let prestigePoints = 0;
let prestigeMultiplier = 1;

/* ===========================
   DOM ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨é…åˆ—ï¼ˆåˆæœŸåŒ–æ™‚ã«ä½œã‚‹ï¼‰
   å„è¦ç´ : { root, fillEl, levelEl, costBtn, multEl, rateEl }
   =========================== */
const upgradeUI = [];

/* ===========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   =========================== */
function formatNumCompact(n){
  if (typeof n !== 'number') return String(n);
  if (!isFinite(n)) return "Infinity";
  const abs = Math.abs(n);
  if (abs >= 1e12) return n.toExponential(2);
  if (abs >= 1e6) return Math.floor(n/1000)/1000 + "M"; // 1,200,000 -> 1.2M (simple)
  return Math.floor(n).toLocaleString();
}
function getUpgradeCost(u){ return Math.floor(u.baseCost * Math.pow(2.2, u.level)); }

/* ===========================
   åˆæœŸ UI ä½œæˆï¼ˆæœ€å°é™ã® DOM æ§‹ç¯‰ï¼‰
   â€» æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†æ§‹ç¯‰ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
   =========================== */
function initUpgradeUI(){
  const container = document.getElementById("upgradeContainer");
  container.innerHTML = "";
  upgrades.forEach((u,i)=>{
    const div = document.createElement("div");
    div.className = "upgrade";
    div.innerHTML = `
      <div class="flex-row"><strong>${u.name}</strong> <span style="margin-left:8px;color:#ccc">Lv <span class="lvl" id="lvl${i}">0</span></span></div>
      <div style="margin-top:6px;color:#ddd">ä¹—æ•°åˆè¨ˆ: <span id="mult${i}">+0.000</span></div>
      <div style="margin-top:4px;color:#ccc">ãƒ¡ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦: <span id="rate${i}">${u.rate.toFixed(2)}</span> /s</div>
      <div class="meter"><div id="fill${i}" class="fill" style="width:0%"></div></div>
      <div class="flex-row" style="margin-top:6px">
        <button id="btn${i}">è³¼å…¥ï¼ˆ<span id="cost${i}">0</span>ï¼‰</button>
      </div>
    `;
    container.appendChild(div);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    upgradeUI[i] = {
      root: div,
      fillEl: document.getElementById("fill"+i),
      levelEl: document.getElementById("lvl"+i),
      costEl: document.getElementById("cost"+i),
      multEl: document.getElementById("mult"+i),
      rateEl: document.getElementById("rate"+i),
      btnEl: document.getElementById("btn"+i),
    };
    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šï¼ˆã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ä¸è¦ã€iã‚’æ¸¡ã™ï¼‰
    upgradeUI[i].btnEl.addEventListener('click', ()=> buyUpgrade(i));
  });
}

/* ===========================
   è¡¨ç¤ºæ›´æ–°ï¼ˆé‡ã„å‡¦ç†ã¯é »åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
   - è¨ˆç®—ã¯æ¯ãƒ•ãƒ¬ãƒ¼ãƒ è¡Œã†ãŒ DOM æ›´æ–°ã¯100msæ¯ã«é™å®š
   =========================== */
let lastUIUpdate = 0;
function updateDisplayThrottled(force=false){
  const now = performance.now();
  if (!force && now - lastUIUpdate < 100) return; // 100ms ã”ã¨ã ã‘æ›´æ–°
  lastUIUpdate = now;

  // åŸºæœ¬æƒ…å ±
  document.getElementById("money").textContent = formatNumCompact(money);
  const totalMult = upgrades.reduce((acc,u)=> acc * (1 + u.mult), 1) * prestigeMultiplier;
  document.getElementById("rate").textContent = (baseIncome * totalMult).toFixed(2);
  document.getElementById("formula").textContent =
    `åå…¥ = ${baseIncome} Ã— ` + upgrades.map(u=>`(1+${u.mult.toFixed(3)})`).join(" Ã— ") + ` Ã— ${prestigeMultiplier.toFixed(2)}`;

  // è»¢ç”Ÿæƒ…å ±
  document.getElementById("prestigePoints").textContent = prestigePoints;
  document.getElementById("prestigeMult").textContent = prestigeMultiplier.toFixed(2);

  // å€‹åˆ¥ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰éƒ¨åˆ†ã®ã¿å·®åˆ†æ›´æ–°
  upgrades.forEach((u,i)=>{
    const ui = upgradeUI[i];
    if (!ui) return;
    ui.levelEl.textContent = u.level;
    ui.costEl.textContent = formatNumCompact(getUpgradeCost(u));
    ui.multEl.textContent = `+${u.mult.toFixed(3)}`;
    ui.rateEl.textContent = u.rate.toFixed(2);
    // fill ã¯é »ç¹ã«å¤‰ã‚ã‚‹ã®ã§åˆ¥ã§ç›´æ¥æ›´æ–°ï¼ˆã“ã“ã§ã‚‚æ›´æ–°å¯ï¼‰
    ui.fillEl.style.width = Math.min(u.progress,100) + "%";
  });

  // è»¢ç”Ÿãƒœã‚¿ãƒ³ enable åˆ¤å®šï¼ˆ1.8e308 ã¾ãŸã¯ Infinityï¼‰
  const canPrestige = (!isFinite(money) || money >= 1.8e308);
  document.getElementById("prestigeBtn").disabled = !canPrestige;
}

/* ===========================
   è³¼å…¥å‡¦ç†
   =========================== */
function buyUpgrade(i){
  const u = upgrades[i];
  const cost = getUpgradeCost(u);
  if (money >= cost){
    money -= cost;
    u.level++;
    u.rate *= u.speedMult; // ãƒ¬ãƒ¼ãƒˆã‚’ä¸Šã’ã‚‹
    saveGame();
    updateDisplayThrottled(true);
  } else {
    alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
  }
}

/* ===========================
   ä¹—æ•°å¢—åˆ†ï¼ˆãƒ¬ãƒ™ãƒ«ä¾å­˜ï¼‰
   =========================== */
function getMultiplierIncrement(u){
  return 0.01 * (1 + u.level);
}

/* ===========================
   è»¢ç”Ÿå‡¦ç†
   =========================== */
function doPrestige(force=false){
  if (!force){
    if (!(money >= 1.8e308 || !isFinite(money))){
      alert("è»¢ç”Ÿæ¡ä»¶ã«é”ã—ã¦ã„ã¾ã›ã‚“ï¼ˆé€šå¸¸ã¯ 1.8e308ï¼‰ã€‚");
      return;
    }
    if (!confirm("æœ¬å½“ã«è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ æ‰€æŒé‡‘ã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚")) return;
  }
  prestigePoints += 1;
  prestigeMultiplier += 1;
  money = 0;
  upgrades = cloneTemplate();
  // å†ä½œæˆ UIï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå¤‰ã‚ã£ãŸãŸã‚ï¼‰
  initUpgradeUI();
  saveGame();
  updateDisplayThrottled(true);
  alert("è»¢ç”Ÿå®Œäº†ï¼ è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ +1");
}

/* ===========================
   ã‚»ãƒ¼ãƒ– / ãƒ­ãƒ¼ãƒ‰
   =========================== */
function saveGame(){
  try {
    const save = { money, baseIncome, upgrades, prestigePoints, prestigeMultiplier };
    localStorage.setItem("idleSafeSave", JSON.stringify(save));
  } catch(e){ console.warn("save failed", e); }
}

function loadGame(){
  try {
    const raw = localStorage.getItem("idleSafeSave");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (typeof data.money === 'number') money = data.money;
    if (typeof data.baseIncome === 'number') baseIncome = data.baseIncome;
    if (Array.isArray(data.upgrades) && data.upgrades.length === upgradesTemplate.length) upgrades = data.upgrades;
    if (typeof data.prestigePoints === 'number') prestigePoints = data.prestigePoints;
    if (typeof data.prestigeMultiplier === 'number') prestigeMultiplier = data.prestigeMultiplier;
  } catch(e){ console.warn("load failed", e); }
}

/* ===========================
   ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€é©åŒ–ã•ã‚ŒãŸå®‰å…¨ç‰ˆï¼‰
   =========================== */
initUpgradeUI();
loadGame();
updateDisplayThrottled(true);

let last = Date.now();
function loop(){
  const now = Date.now();
  let delta = (now - last) / 1000;
  last = now;

  // deltaãŒå¤§ãããªã‚Šã™ãã‚‹ã¨å‡¦ç†ãŒå¹ã£é£›ã¶åŸå› ã«ãªã‚‹ãŸã‚ä¸Šé™ã‚’è¨­ã‘ã‚‹
  if (!isFinite(delta) || delta <= 0) delta = 0;
  const MAX_DELTA = 1.0; // 1ç§’åˆ†ã‚’æœ€å¤§
  if (delta > MAX_DELTA) delta = MAX_DELTA;

  // å„ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°
  upgrades.forEach(u=>{
    // u.rate ã¯ "å˜ä½ï¼šprogress% per second ã®ç´ "
    // progress ã®å˜ä½ã¯ 0..100 (%)
    u.progress += u.rate * delta * 100;

    // ä¸€æ‹¬å‡¦ç†ï¼šä½•å›åˆ†æºœã¾ã£ãŸã‹ã‚’è¨ˆç®—ï¼ˆãƒ«ãƒ¼ãƒ—ã§1ã¤ãšã¤å‡¦ç†ã—ãªã„ï¼‰
    if (u.progress >= 100){
      let completed = Math.floor(u.progress / 100);
      // æ¥µç«¯ã«å¤§ãã„ completed ãŒæ¥ã‚‹ã¨è¨ˆç®—ãŒé‡ããªã‚‹ï¼ˆä¾‹ï¼šã‚¿ãƒ–é•·æ™‚é–“éè¡¨ç¤ºâ†’å¾©å¸°ï¼‰
      // ãªã®ã§ä¸Šé™ã‚’è¨­ã‘ã‚‹ï¼ˆå¿…è¦ãªã‚‰å¢—ã‚„ã™ï¼‰
      const MAX_COMPLETED = 1e6;
      if (completed > MAX_COMPLETED){
        completed = MAX_COMPLETED;
      }
      u.progress -= completed * 100;
      // ã¾ã¨ã‚ã¦ä¹—æ•°ã‚’å¢—ã‚„ã™
      const incPer = getMultiplierIncrement(u);
      u.mult += incPer * completed;
    }
  });

  // åå…¥åŠ ç®—ï¼ˆæ›ã‘ç®—ï¼‰
  const totalMult = upgrades.reduce((acc,u) => acc * (1 + u.mult), 1) * prestigeMultiplier;
  money += baseIncome * totalMult * delta;

  // UIæ›´æ–°ã¯ throttle ã‚’ä½¿ã†ï¼ˆæ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã ã¨é‡ã„ï¼‰
  updateDisplayThrottled();

  // è‡ªå‹•ã‚»ãƒ¼ãƒ–ï¼ˆ5ç§’ã”ã¨ï¼‰ - 1ç§’æœªæº€ã®èª¤å·®ç„¡è¦–
  if (Date.now() % 5000 < 16) saveGame();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===========================
   URL ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä»»æ„ï¼‰
   ?forcePrestige=1 ã§å³è»¢ç”Ÿï¼ˆãƒ†ã‚¹ãƒˆï¼‰
   ?money=1.8e308 ã§åˆæœŸè³‡é‡‘ã‚»ãƒƒãƒˆ
   =========================== */
const params = new URLSearchParams(location.search);
if (params.get("money")){
  const m = Number(params.get("money"));
  if (isFinite(m)) money = m;
  else money = Number(params.get("money"));
  updateDisplayThrottled(true);
}
if (params.get("forcePrestige")==="1" || params.get("forcePrestige")==="true"){
  setTimeout(()=> doPrestige(true), 200);
}
</script>
</body>
</html>
