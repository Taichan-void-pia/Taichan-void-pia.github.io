<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Idle â€” Prestige + Fixes</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:system-ui, "Segoe UI", Roboto, Helvetica, Arial; background:#071018;color:#fff;margin:0;padding:16px}
  h1{color:#7bf3a8;margin:0 0 8px 0}
  .errorBanner{background:#5b1010;color:#fff;padding:8px;border-radius:6px;margin-bottom:10px;display:none}
  .stats{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:10px}
  #money{font-weight:700;color:#7bf3a8}
  #upgradeContainer{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .upgrade{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .meter{height:14px;background:rgba(255,255,255,0.04);border-radius:7px;overflow:hidden;margin:6px 0}
  .fill{height:100%;background:linear-gradient(90deg,#7bf3a8,#39d092);width:100%;transform-origin:left;will-change:transform}
  .btn{padding:6px;border-radius:6px;border:0;cursor:pointer}
  .btn-primary{background:#7bf3a8;color:#003628}
  .btn-small{background:rgba(255,255,255,0.03);color:#cfe8da;padding:4px 6px}
  .panel{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .small{font-size:0.85em;color:#cfe8da}
  .speedControls{display:flex;gap:8px;align-items:center}
  .invisible{display:none}
  .shop{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .shop .card{background:rgba(255,255,255,0.03);padding:8px;border-radius:6px}
</style>
</head>
<body>
  <div id="error" class="errorBanner"></div>

  <h1>ğŸ’° æ”¾ç½®ã‚²ãƒ¼ãƒ  â€” Prestige & Fixes</h1>

  <div class="stats">
    æ‰€æŒé‡‘ï¼š<span id="money">0</span>ã€€
    ç§’ã‚ãŸã‚Šï¼š<span id="rate">0</span>
    <div class="small" id="formula">(è¨ˆç®—å¼)</div>
    <div style="margin-top:8px">
      ç„¡é™ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼š<div class="meter" style="display:inline-block;width:40%;margin-left:8px;vertical-align:middle"><div id="inftyFill" class="fill" style="transform:scaleX(0)"></div></div>
      <button id="gainInfinityBtn" class="btn btn-primary invisible" style="margin-left:10px">ç„¡é™ã‚’å¾—ã‚‹</button>
      <span class="small" style="margin-left:8px">ç„¡é™ãƒã‚¤ãƒ³ãƒˆ: <span id="inftyPoints">0</span></span>
    </div>
  </div>

  <div class="panel">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="prestigeBtn" class="btn btn-primary invisible">âœ¨ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸</button>
      <button id="resetBtn" class="btn btn-small">ãƒªã‚»ãƒƒãƒˆï¼ˆå®Œå…¨ï¼‰</button>
      <label class="small" style="margin-left:8px">Auto-buy:
        <select id="autoQty">
          <option value="1">Ã—1</option><option value="10">Ã—10</option><option value="100">Ã—100</option><option value="max">Ã—Max</option>
        </select>
        <input id="autoToggle" type="checkbox" style="margin-left:6px" />ï¼ˆãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸1å›å¾Œã«æœ‰åŠ¹ï¼‰
      </label>
    </div>

    <div class="speedControls small" style="margin-left:auto">
      å€é€Ÿï¼š
      <select id="speedSelect">
        <option value="1">1Ã—</option>
        <option value="2">2Ã—</option>
        <option value="3">3Ã—</option>
      </select>
      <button id="speedDec" class="btn btn-small">-</button>
      <button id="speedInc" class="btn btn-small">+</button>
      <button id="pauseBtn" class="btn btn-small">ä¸€æ™‚åœæ­¢</button>
    </div>

    <div class="small" style="width:100%;margin-top:6px">ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸åˆå›æ¡ä»¶: 1e20ï¼ˆ2å›ç›®ä»¥é™ã¯å‰å›ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸æ™‚ã®ã‚¹ã‚³ã‚¢ã‚ˆã‚Šä¸Šï¼‰ â€” æ˜‡å¤©ã¯Lvä¸Šé™åˆ°é”ã§è¡¨ç¤ºãƒ»å®Ÿè¡Œå¯èƒ½</div>
  </div>

  <div id="upgradeContainer"></div>

  <div id="prestigeShop" class="shop"></div>

<script>
(function(){
  function showError(msg){
    const el = document.getElementById('error');
    el.style.display = 'block';
    el.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + msg;
    console.error(msg);
  }

  try {
    // -------- BigNum (è»½é‡) ----------
    class BigNum {
      constructor(m=0,e=0){ this.m=m; this.e=e; this._normalize(); }
      static zero(){ return new BigNum(0,0); }
      static fromNumber(n){ if (!isFinite(n) || n === 0) return BigNum.zero(); const sign = n<0?-1:1; n=Math.abs(n); const exp=Math.floor(Math.log10(n)); const mant=n/Math.pow(10,exp); return new BigNum(sign*mant, exp); }
      static fromObject(o){ if (!o || typeof o.m!=='number' || typeof o.e!=='number') return BigNum.zero(); return new BigNum(o.m, o.e); }
      static fromMantExp(m,e){ return new BigNum(m,e); }
      clone(){ return new BigNum(this.m, this.e); }
      _normalize(){
        if (!isFinite(this.m) || !isFinite(this.e) || this.m === 0){
          if (this.m === 0){ this.e = 0; this.m = 0; return; }
          if (!isFinite(this.m)) this.m = this.m > 0 ? 9.9999999999999 : -9.9999999999999;
        }
        if (this.m === 0){ this.e = 0; return; }
        let sign = this.m < 0 ? -1 : 1;
        let mabs = Math.abs(this.m);
        if (mabs === 0){ this.m = 0; this.e = 0; return; }
        const shift = Math.floor(Math.log10(mabs));
        if (isFinite(shift) && shift !== 0){ mabs = mabs / Math.pow(10, shift); this.e = this.e + shift; }
        if (mabs >= 10){ mabs = mabs / 10; this.e = this.e + 1; }
        this.m = sign * mabs;
      }
      toObject(){ return {m:this.m, e:this.e}; }
      toNumberSafe(){ if (!isFinite(this.m) || !isFinite(this.e)) return NaN; if (this.e > 15 || this.e < -15) return this.m>0?Infinity:-Infinity; return this.m * Math.pow(10, this.e); }
      toString(){ if (this.m === 0) return "0"; if (this.e <=12 && this.e >= -6){ const v=this.toNumberSafe(); if (isFinite(v)) return v.toLocaleString(undefined,{maximumFractionDigits:2}); } return this.m.toFixed(3) + "e" + this.e; }
      addInPlace(other){ if (typeof other === 'number') other = BigNum.fromNumber(other); if (!(other instanceof BigNum)) return; if (this.m === 0){ this.m = other.m; this.e = other.e; return; } if (other.m === 0) return; const diff = this.e - other.e; if (Math.abs(diff) > 15){ if (diff > 0) return; else { this.m = other.m; this.e = other.e; return; } } if (diff >= 0){ const scaled = other.m * Math.pow(10, -diff); this.m = this.m + scaled; } else { const scaled = this.m * Math.pow(10, diff); this.m = other.m + scaled; this.e = other.e; } this._normalize(); }
      subInPlace(other){ if (typeof other === 'number') other = BigNum.fromNumber(other); if (!(other instanceof BigNum)) return; other = new BigNum(-other.m, other.e); this.addInPlace(other); }
      mulInPlace(other){ if (typeof other === 'number'){ if (!isFinite(other) || other === 0){ this.m = 0; this.e = 0; return; } other = BigNum.fromNumber(other); } if (!(other instanceof BigNum)) return; if (this.m === 0 || other.m === 0){ this.m = 0; this.e = 0; return; } this.m = this.m * other.m; this.e = this.e + other.e; this._normalize(); }
      mulByNumber(n){ if (typeof n !== 'number') return; if (!isFinite(n) || n === 0){ this.m = 0; this.e = 0; return; } this.m = this.m * n; this._normalize(); }
      addNumber(n){ this.addInPlace(BigNum.fromNumber(n)); }
      gteNumber(n){ if (typeof n !== 'number') n = Number(n); if (!isFinite(n)) return false; if (n === 0) return this.m >= 0; const bn = BigNum.fromNumber(n); return this.gteBig(bn); }
      gteBig(b){ if (!(b instanceof BigNum)) b = BigNum.fromObject(b); if (this.m === 0 && b.m === 0) return true; if (this.e !== b.e) return this.e > b.e; return Math.abs(this.m) >= Math.abs(b.m); }
    }

    // --------------- constants & templates ---------------
    const INF_TARGET = BigNum.fromMantExp(1.8, 308); // 1.8e308
    const PROGRESS_CAP = 1e9;
    // cost growth variable (can be adjusted by prestige shop)
    let costBaseMultVar = 1.15;

    const upgradesTemplate = [
      { name:"åå…¥ã‚¢ãƒƒãƒ—", baseRate:0.9, rate:0.9, mult:0, speedMult:1.18, baseCost:12, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"åŠ¹ç‡ã‚¢ãƒƒãƒ—", baseRate:0.6, rate:0.6, mult:0, speedMult:1.16, baseCost:40, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"è‡ªå‹•è²©å£²æ©Ÿ", baseRate:0.45, rate:0.45, mult:0, speedMult:1.14, baseCost:120, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"éŠ€è¡ŒæŠ•è³‡", baseRate:0.3, rate:0.3, mult:0, speedMult:1.12, baseCost:520, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"AIç”Ÿæˆå·¥å ´", baseRate:0.18, rate:0.18, mult:0, speedMult:1.10, baseCost:2200, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", baseRate:0.14, rate:0.14, mult:0, speedMult:1.09, baseCost:12000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"ç ”ç©¶æ‰€", baseRate:0.11, rate:0.11, mult:0, speedMult:1.085, baseCost:60000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"æƒ‘æ˜Ÿé–‹ç™º", baseRate:0.08, rate:0.08, mult:0, speedMult:1.07, baseCost:250000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"é‡å­ã‚µãƒ¼ãƒãƒ¼", baseRate:0.05, rate:0.05, mult:0, speedMult:1.055, baseCost:1200000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
      { name:"æ¬¡å…ƒã‚³ã‚¢", baseRate:0.02, rate:0.02, mult:0, speedMult:1.04, baseCost:6000000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0, purchasePenalty:0 },
    ];
    function cloneTemplate(){ return JSON.parse(JSON.stringify(upgradesTemplate)); }

    // --------------- state ---------------
    let money = BigNum.zero();
    let baseIncome = BigNum.fromNumber(1);
    let upgrades = cloneTemplate();
    let prestigePoints = 0; // integer points user can spend in shop
    let prestigeCount = 0;
    let prestigeMult = BigNum.fromNumber(1);
    let lastPrestigeScore = BigNum.zero();
    let infinityPoints = 0;

    // global prestige bonuses (purchased with prestigePoints)
    const globalPrestige = {
      mAdd: 0,   // additive to upgrade _mult (as number)
      rMul: 1.0, // multiplicative to upgrade rate
      costMul: 1.0, // multiplicative to cost (less than 1 reduces cost)
    };

    let speedMultiplier = 1.0; // 1..3
    let paused = false;

    let displayMoneyNum = 0;
    let prevProgress = [];
    let currProgress = [];
    const upgradeUI = [];

    // helpers
    function fmtSmall(n){
      if (typeof n === 'number'){
        if (!isFinite(n)) return "Infinity";
        if (Math.abs(n) >= 1e15) return n.toExponential(2);
        if (Math.abs(n) >= 1e9) return (n/1e9).toFixed(2) + "B";
        if (Math.abs(n) >= 1e6) return (n/1e6).toFixed(2) + "M";
        return Math.floor(n).toLocaleString();
      }
      return String(n);
    }

    function sanitizeUpgrades(list){
      for (let i=0;i<list.length;i++){
        const u = list[i];
        if (!u || typeof u !== 'object'){ list[i] = JSON.parse(JSON.stringify(upgradesTemplate[i])); continue; }
        if (typeof u.mult !== 'number') u.mult = 0;
        if (typeof u.rate !== 'number') u.rate = u.baseRate || upgradesTemplate[i].baseRate;
        if (typeof u.baseCost !== 'number') u.baseCost = upgradesTemplate[i].baseCost;
        if (typeof u.level !== 'number') u.level = 0;
        if (typeof u.progress !== 'number') u.progress = 0;
        if (!u.prestigeLevel || typeof u.prestigeLevel !== 'object') u.prestigeLevel = {mult:0,rate:0,cost:0};
        if (typeof u.ascendCount !== 'number') u.ascendCount = 0;
        if (typeof u.purchasePenalty !== 'number') u.purchasePenalty = 0;
        u._rateBN = u._rateBN ? BigNum.fromObject(u._rateBN) : BigNum.fromNumber(u.rate);
        u._multBN = u._multBN ? BigNum.fromObject(u._multBN) : BigNum.fromNumber(u.mult);
        u._baseCostBN = u._baseCostBN ? BigNum.fromObject(u._baseCostBN) : BigNum.fromNumber(u.baseCost);
      }
    }

    function getLevelCap(u){
      return 100 + (u.ascendCount || 0) * 10;
    }

    function getUpgradeCostBig(u, extraLevelOffset=0){
      const level = (u.level + extraLevelOffset);
      const factor = Math.pow(costBaseMultVar, Math.max(0, level));
      const c = u._baseCostBN.clone();
      c.mulByNumber(factor);
      // per-upgrade permanent purchase penalty (stronger now)
      const penalty = 1 + (u.purchasePenalty || 0);
      c.mulByNumber(penalty);
      // global prestige cost multiplier
      c.mulByNumber(globalPrestige.costMul);
      return c;
    }

    // UI init
    function initUI(){
      const container = document.getElementById('upgradeContainer');
      container.innerHTML = '';
      upgrades.forEach((u,i)=>{
        const div = document.createElement('div');
        div.className = 'upgrade';
        const rateStr = (u._rateBN && u._rateBN.toNumberSafe && isFinite(u._rateBN.toNumberSafe())) ? u._rateBN.toNumberSafe().toFixed(2) : u._rateBN.toString();
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between"><strong>${i+1}. ${u.name}</strong><div class="small">Lv <span id="lvl${i}">0</span>/<span id="cap${i}">100</span></div></div>
          <div class="small">æ˜‡å¤©å›æ•°: <span id="asc${i}">0</span></div>
          <div class="small">æ°¸ç¶š Lv(m/r/c): <span id="pLv${i}">0</span>/<span id="pLvR${i}">0</span>/<span id="pLvC${i}">0</span></div>
          <div class="small">ä¹—æ•°åˆè¨ˆ: <span id="mult${i}">+0.000</span></div>
          <div class="small">ãƒ¡ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦: <span id="rate${i}">${rateStr}</span>/s</div>
          <div class="meter"><div id="fill${i}" class="fill" style="transform:scaleX(0)"></div></div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
            <button id="buy1_${i}" class="btn btn-primary">è³¼å…¥ï¼ˆ<span id="cost${i}">0</span>ï¼‰</button>
            <button id="buy10_${i}" class="btn btn-small">Ã—10</button>
            <button id="buy100_${i}" class="btn btn-small">Ã—100</button>
            <button id="buyMax_${i}" class="btn btn-small">Ã—Max</button>
            <button id="asc_${i}" class="btn btn-small invisible">æ˜‡å¤©</button>
          </div>
        `;
        container.appendChild(div);
        upgradeUI[i] = {
          fillEl: document.getElementById('fill'+i),
          lvlEl: document.getElementById('lvl'+i),
          capEl: document.getElementById('cap'+i),
          costEl: document.getElementById('cost'+i),
          multEl: document.getElementById('mult'+i),
          rateEl: document.getElementById('rate'+i),
          ascEl: document.getElementById('asc'+i),
          pLvEl: document.getElementById('pLv'+i),
          pLvREl: document.getElementById('pLvR'+i),
          pLvCEl: document.getElementById('pLvC'+i),
          btn1: document.getElementById('buy1_'+i),
          btn10: document.getElementById('buy10_'+i),
          btn100: document.getElementById('buy100_'+i),
          btnMax: document.getElementById('buyMax_'+i),
          btnAsc: document.getElementById('asc_'+i),
        };
        upgradeUI[i].btn1.addEventListener('click', ()=> buyUpgrade(i,1,false));
        upgradeUI[i].btn10.addEventListener('click', ()=> buyUpgrade(i,10,false));
        upgradeUI[i].btn100.addEventListener('click', ()=> buyUpgrade(i,100,false));
        upgradeUI[i].btnMax.addEventListener('click', ()=> buyUpgrade(i,'max',false));
        upgradeUI[i].btnAsc.addEventListener('click', ()=> tryAscend(i));
      });

      // ensure prev/curr arrays match new upgrades length
      prevProgress = new Array(upgrades.length).fill(0);
      currProgress = new Array(upgrades.length).fill(0);
      for (let i=0;i<upgrades.length;i++){ prevProgress[i] = upgrades[i].progress || 0; currProgress[i] = upgrades[i].progress || 0; }

      renderPrestigeShop();
    }

    // throttled UI update
    let lastUI = 0;
    function updateUI_throttled(force){
      const now = performance.now();
      if (!force && now - lastUI < 100) return;
      lastUI = now;

      let totalMultBN = BigNum.fromNumber(1);
      for (let i=0;i<upgrades.length;i++){
        const u = upgrades[i];
        const pMult = 0.02 * ((u.prestigeLevel && u.prestigeLevel.mult) || 0);
        const asc = 0.05 * (u.ascendCount || 0);
        const factorBN = BigNum.fromNumber(1);
        factorBN.addInPlace(u._multBN);
        // add global prestige mAdd as number (applies to all upgrades)
        factorBN.addNumber(pMult + asc + (globalPrestige.mAdd || 0));
        totalMultBN.mulInPlace(factorBN);
      }

      const rateBN = baseIncome.clone();
      rateBN.mulInPlace(totalMultBN);
      const rateDisplay = rateBN.toNumberSafe();
      document.getElementById('rate').textContent = isFinite(rateDisplay) ? rateDisplay.toFixed(2) : rateBN.toString();

      let formulaParts = upgrades.map(u=>{
        const n = (u._multBN && u._multBN.toNumberSafe && isFinite(u._multBN.toNumberSafe())) ? u._multBN.toNumberSafe() : 0;
        const part = 1 + n + 0.02 * ((u.prestigeLevel&&u.prestigeLevel.mult)||0) + 0.05 * (u.ascendCount||0) + (globalPrestige.mAdd || 0);
        return '(1+' + part.toFixed(3) + ')';
      });
      document.getElementById('formula').textContent = 'åå…¥ = baseIncome Ã— ' + formulaParts.join(' Ã— ') + '  ï¼ˆå€é€Ÿ: ' + speedMultiplier.toFixed(0) + (paused ? ' åœæ­¢ä¸­' : '') + 'ï¼‰';

      for (let i=0;i<upgrades.length;i++){
        const u = upgrades[i], ui = upgradeUI[i];
        if (!ui) continue;
        ui.lvlEl.textContent = u.level;
        ui.capEl.textContent = getLevelCap(u);
        ui.costEl.textContent = getUpgradeCostBig(u,0).toString();
        const multNum = u._multBN.toNumberSafe();
        ui.multEl.textContent = '+' + (isFinite(multNum) ? multNum.toFixed(3) : u._multBN.toString());
        // apply global r multiplier when showing rate
        const rateClone = u._rateBN.clone();
        rateClone.mulByNumber(globalPrestige.rMul || 1);
        const rateNum = rateClone.toNumberSafe();
        ui.rateEl.textContent = isFinite(rateNum) ? rateNum.toFixed(2) : rateClone.toString();
        ui.ascEl.textContent = u.ascendCount || 0;
        ui.pLvEl.textContent = (u.prestigeLevel && u.prestigeLevel.mult) || 0;
        ui.pLvREl.textContent = (u.prestigeLevel && u.prestigeLevel.rate) || 0;
        ui.pLvCEl.textContent = (u.prestigeLevel && u.prestigeLevel.cost) || 0;

        if (u.level >= getLevelCap(u)) ui.btnAsc.classList.remove('invisible'); else ui.btnAsc.classList.add('invisible');
        const canBuy = u.level < getLevelCap(u);
        ui.btn1.disabled = !canBuy;
        ui.btn10.disabled = !canBuy;
        ui.btn100.disabled = !canBuy;
        ui.btnMax.disabled = !canBuy;
      }

      const prestigeBtn = document.getElementById('prestigeBtn');
      let canPrestige = false;
      if (money.gteNumber(1e20)) {
        if (prestigeCount === 0) canPrestige = true;
        else { if (money.gteBig(lastPrestigeScore) && !money.gteBig(lastPrestigeScore)===false && !money.gteBig(lastPrestigeScore)) {
          // fallback, but we'll require strictly greater below
        }
          // require strictly greater than previous prestige score
          if (isMoneyGreaterThan(money, lastPrestigeScore)) canPrestige = true;
        }
      }
      if (canPrestige) prestigeBtn.classList.remove('invisible'); else prestigeBtn.classList.add('invisible');

      const inftyFill = document.getElementById('inftyFill');
      const inftyBtn = document.getElementById('gainInfinityBtn');
      const pct = computeInfinityProgressPercent(money);
      inftyFill.style.transform = 'scaleX(' + (pct/100) + ')';
      if (money.gteBig(INF_TARGET)) inftyBtn.classList.remove('invisible'); else inftyBtn.classList.add('invisible');

      document.getElementById('inftyPoints').textContent = String(infinityPoints);

      // prestige points display on shop render
      renderPrestigeShop();
    }

    function isMoneyGreaterThan(a,b){
      // return true if BigNum a > BigNum b
      if (!(a instanceof BigNum)) a = BigNum.fromObject(a);
      if (!(b instanceof BigNum)) b = BigNum.fromObject(b);
      if (a.e !== b.e) return a.e > b.e;
      return Math.abs(a.m) > Math.abs(b.m);
    }

    function computeInfinityProgressPercent(bn){
      if (!(bn instanceof BigNum)) bn = BigNum.fromObject(bn);
      if (bn.m === 0) return 0;
      const diff = bn.e - INF_TARGET.e;
      if (diff > 0) return 100;
      // compute ratio robustly using mantissa
      const ratio = (bn.m / INF_TARGET.m) * Math.pow(10, diff);
      if (!isFinite(ratio) || ratio <= 0) return 0;
      return Math.min(100, ratio * 100);
    }

    function costToBuyBig(u, n){
      if (n <= 0) return BigNum.zero();
      const remaining = Math.max(0, getLevelCap(u) - u.level);
      const want = Math.min(n, remaining);
      let total = BigNum.zero();
      for (let k=0;k<want;k++){
        const piece = getUpgradeCostBig(u, k);
        total.addInPlace(piece);
      }
      return total;
    }

    function buyUpgrade(idx, qty, silent){
      // silent = true when auto-buy, avoid alerts
      const u = upgrades[idx];
      if (u.level >= getLevelCap(u)){ if (!silent) alert('ã“ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯æœ€å¤§Lvã§ã™ï¼ˆ' + getLevelCap(u) + 'ï¼‰'); return; }
      if (qty === 'max'){
        const remaining = getLevelCap(u) - u.level;
        let lo = 0, hi = 1;
        while (hi <= remaining && money.gteBig(costToBuyBig(u,hi))) hi *= 2;
        hi = Math.min(hi, remaining);
        while (lo + 1 < hi){
          const mid = Math.floor((lo + hi)/2);
          if (money.gteBig(costToBuyBig(u, mid))) lo = mid;
          else hi = mid;
        }
        if (lo > 0) doPurchase(u, idx, lo);
        else if (!silent) alert('ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');
        return;
      }
      const n = Number(qty) || 1;
      const allowed = Math.min(n, getLevelCap(u) - u.level);
      if (allowed <= 0){ if (!silent) alert('ã“ã‚Œä»¥ä¸Šè³¼å…¥ã§ãã¾ã›ã‚“ï¼ˆLvä¸Šé™ï¼‰'); return; }
      const costBN = costToBuyBig(u, allowed);
      if (money.gteBig(costBN)) doPurchase(u, idx, allowed);
      else if (!silent) alert('ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');
    }

    function doPurchase(u, idx, n){
      const costBN = costToBuyBig(u, n);
      money.subInPlace(costBN);
      const exponent = n * 0.12;
      const multiplier = Math.pow(Math.max(1, u.speedMult), exponent);
      u._rateBN.mulByNumber(multiplier);
      if (u._rateBN.e > 300) u._rateBN = BigNum.fromNumber(1e300);
      u.level += n;
      saveGame();
      updateUI_throttled(true);
    }

    function getMultiplierIncrementBig(u){
      const base = 0.005 * Math.pow(1 + u.level, 0.38);
      return BigNum.fromNumber(Math.min(base, 1e12));
    }

    function tryAscend(i){
      const u = upgrades[i];
      if (u.level < getLevelCap(u)){ alert('Lvä¸Šé™ã«åˆ°é”ã—ã¦ã‹ã‚‰æ˜‡å¤©å¯èƒ½ã§ã™ï¼ˆç¾åœ¨ Lv ' + u.level + ' / ' + getLevelCap(u) + 'ï¼‰'); return; }
      if (!confirm(u.name + ' ã‚’æ˜‡å¤©ã—ã¾ã™ã‹ï¼Ÿ LvãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€æ°¸ç¶šãƒœãƒ¼ãƒŠã‚¹ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚')) return;
      u.ascendCount = (u.ascendCount || 0) + 1;
      // stronger permanent purchase penalty per ascend
      u.purchasePenalty = (u.purchasePenalty || 0) + 0.25; // +25% per ascend
      u.level = 0;
      u.progress = 0;
      u._rateBN = BigNum.fromNumber(u.baseRate || 1);
      u._multBN = BigNum.zero();
      saveGame();
      updateUI_throttled(true);
      alert(u.name + ' ã‚’æ˜‡å¤©ã—ã¾ã—ãŸï¼ˆæ˜‡å¤©å›æ•°: ' + u.ascendCount + 'ï¼‰\nè©²å½“ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚³ã‚¹ãƒˆãŒæ°¸ç¶šã§ +25% ã•ã‚Œã¾ã—ãŸã€‚');
    }

    // PRESTIGE logic (doPrestige): award prestigePoints based on how far above 1e20
    function prestigePointsForScore(bn){
      if (!(bn instanceof BigNum)) bn = BigNum.fromObject(bn);
      if (bn.m === 0) return 0;
      // compute log10(bn) - 20, floor +1
      const mantLog = Math.log10(Math.abs(bn.m));
      const log10val = bn.e + mantLog;
      const diff = log10val - 20;
      if (!isFinite(diff) || diff < 0) return 0;
      const points = Math.floor(diff) + 1; // 1e20 => points=1, 1e21.. => >=2
      return points;
    }

    function doPrestige(force){
      // canPrestige: first time require >=1e20; subsequent require strictly > lastPrestigeScore
      let can = false;
      if (money.gteNumber(1e20)){
        if (prestigeCount === 0) can = true;
        else if (isMoneyGreaterThan(money, lastPrestigeScore)) can = true;
      }
      if (!force && !can){ alert('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“'); return; }
      if (!force && !confirm('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿï¼ˆå…¨ã¦ãƒªã‚»ãƒƒãƒˆã€ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã€‚ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã¯å‰å›ã‚ˆã‚Šé«˜ã„ã‚¹ã‚³ã‚¢ã§ã®ã¿å†åº¦å¯èƒ½ï¼‰')) return;

      const pts = prestigePointsForScore(money);
      if (pts <= 0 && !force){ alert('ã‚¹ã‚³ã‚¢ãŒä¸ååˆ†ã§ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆã¯å¾—ã‚‰ã‚Œã¾ã›ã‚“'); return; }

      prestigePoints += pts;
      prestigeCount += 1;
      lastPrestigeScore = money.clone();

      // reset runtime state (but keep globalPrestige purchases)
      money = BigNum.zero();
      baseIncome = BigNum.fromNumber(1);
      // reset upgrades: clear levels, progress, ascend counts and purchase penalties
      upgrades = cloneTemplate();
      sanitizeUpgrades(upgrades);
      // reset cost growth var? user wanted cost penalty reset on prestige: reset per-upgrade penalties
      // keep globalPrestige (shop purchases) intact
      // reset prestige-related runtime but keep prestigePoints and globalPrestige

      saveGame();
      initUI();
      updateUI_throttled(true);
      alert('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Œäº†: prestigePoints +' + pts + '\nç¾åœ¨ã®ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆ: ' + prestigePoints);
    }

    function gainInfinity(){
      if (!money.gteBig(INF_TARGET)){ alert('ã¾ã ç„¡é™ã«åˆ°é”ã—ã¦ã„ã¾ã›ã‚“'); return; }
      if (!confirm('ç„¡é™ã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…¨ã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã€ç„¡é™ãƒã‚¤ãƒ³ãƒˆ +1ï¼‰')) return;
      infinityPoints += 1;
      // full reset
      money = BigNum.zero();
      baseIncome = BigNum.fromNumber(1);
      upgrades = cloneTemplate();
      sanitizeUpgrades(upgrades);
      prestigePoints = 0;
      prestigeCount = 0;
      prestigeMult = BigNum.fromNumber(1);
      lastPrestigeScore = BigNum.zero();
      costBaseMultVar = 1.15;
      globalPrestige.mAdd = 0; globalPrestige.rMul = 1; globalPrestige.costMul = 1;
      speedMultiplier = 1.0;
      paused = false;
      displayMoneyNum = 0;
      prevProgress = new Array(upgrades.length).fill(0);
      currProgress = new Array(upgrades.length).fill(0);
      initUI();
      saveGame();
      updateUI_throttled(true);
      alert('ç„¡é™ã‚’å¾—ã¾ã—ãŸï¼ ç„¡é™ãƒã‚¤ãƒ³ãƒˆ +1');
    }

    // RESET (full): clear storage + runtime
    function fullReset(){
      try { localStorage.removeItem('idle_all_big_save'); } catch(e){}
      money = BigNum.zero();
      baseIncome = BigNum.fromNumber(1);
      upgrades = cloneTemplate();
      sanitizeUpgrades(upgrades);
      prestigePoints = 0;
      prestigeCount = 0;
      prestigeMult = BigNum.fromNumber(1);
      lastPrestigeScore = BigNum.zero();
      infinityPoints = 0;
      costBaseMultVar = 1.15;
      globalPrestige.mAdd = 0; globalPrestige.rMul = 1; globalPrestige.costMul = 1;
      speedMultiplier = 1.0;
      paused = false;
      displayMoneyNum = 0;
      prevProgress = new Array(upgrades.length).fill(0);
      currProgress = new Array(upgrades.length).fill(0);
      initUI();
      saveGame();
      updateUI_throttled(true);
    }

    // save/load
    function saveGame(){
      try {
        const save = {
          money: money.toObject(),
          baseIncome: baseIncome.toObject(),
          upgrades: upgrades.map(u => ({
            name:u.name, baseRate:u.baseRate,
            rateBN: u._rateBN.toObject(), multBN: u._multBN.toObject(), baseCostBN: u._baseCostBN.toObject(),
            baseCost: u.baseCost, level: u.level, progress: u.progress, prestigeLevel: u.prestigeLevel || {mult:0,rate:0,cost:0}, ascendCount: u.ascendCount || 0, purchasePenalty: u.purchasePenalty || 0
          })),
          prestigePoints,
          prestigeCount,
          prestigeMult: prestigeMult.toObject(),
          lastPrestigeScore: lastPrestigeScore.toObject(),
          infinityPoints,
          globalPrestige,
          costBaseMultVar,
          speedMultiplier,
          paused
        };
        localStorage.setItem('idle_all_big_save', JSON.stringify(save));
      } catch(e){ console.warn('save fail', e); try{ localStorage.removeItem('idle_all_big_save'); }catch(e){} }
    }

    function loadGame(){
      try {
        const raw = localStorage.getItem('idle_all_big_save');
        if (!raw) return;
        let data;
        try { data = JSON.parse(raw); } catch(parseErr){ console.warn('save parse failed, clearing', parseErr); localStorage.removeItem('idle_all_big_save'); return; }
        if (!data || typeof data !== 'object') return;

        if (data.money && typeof data.money.m === 'number') money = BigNum.fromObject(data.money);
        if (data.baseIncome && typeof data.baseIncome.m === 'number') baseIncome = BigNum.fromObject(data.baseIncome);

        if (Array.isArray(data.upgrades) && data.upgrades.length === upgradesTemplate.length){
          upgrades = data.upgrades.map((s,i) => {
            const t = JSON.parse(JSON.stringify(upgradesTemplate[i]));
            const merged = Object.assign(t, s);
            merged._rateBN = (s && s.rateBN) ? BigNum.fromObject(s.rateBN) : BigNum.fromNumber(merged.rate || merged.baseRate || 1);
            merged._multBN = (s && s.multBN) ? BigNum.fromObject(s.multBN) : BigNum.fromNumber(merged.mult || 0);
            merged._baseCostBN = (s && s.baseCostBN) ? BigNum.fromObject(s.baseCostBN) : BigNum.fromNumber(merged.baseCost || upgradesTemplate[i].baseCost);
            merged.level = Number.isFinite(+merged.level) ? Math.max(0, Math.floor(+merged.level)) : 0;
            merged.progress = Number.isFinite(+merged.progress) ? +merged.progress : 0;
            merged.prestigeLevel = merged.prestigeLevel || {mult:0,rate:0,cost:0};
            merged.ascendCount = Number.isFinite(+merged.ascendCount) ? +merged.ascendCount : 0;
            merged.purchasePenalty = Number.isFinite(+merged.purchasePenalty) ? +merged.purchasePenalty : 0;
            return merged;
          });
        }

        if (typeof data.prestigePoints === 'number') prestigePoints = data.prestigePoints;
        if (typeof data.prestigeCount === 'number') prestigeCount = data.prestigeCount;
        if (data.prestigeMult && typeof data.prestigeMult.m === 'number') prestigeMult = BigNum.fromObject(data.prestigeMult);
        if (data.lastPrestigeScore && typeof data.lastPrestigeScore.m === 'number') lastPrestigeScore = BigNum.fromObject(data.lastPrestigeScore);

        if (typeof data.infinityPoints === 'number') infinityPoints = data.infinityPoints;
        if (data.globalPrestige && typeof data.globalPrestige === 'object') Object.assign(globalPrestige, data.globalPrestige);
        if (typeof data.costBaseMultVar === 'number') costBaseMultVar = data.costBaseMultVar;
        if (typeof data.speedMultiplier === 'number') speedMultiplier = Math.max(1, Math.min(3, Math.round(data.speedMultiplier)));
        if (typeof data.paused === 'boolean') paused = !!data.paused;

        sanitizeUpgrades(upgrades);
      } catch(e){ console.warn('loadGame failed, clearing save', e); try{ localStorage.removeItem('idle_all_big_save'); }catch(e){} }
    }

    // simulation + render
    sanitizeUpgrades(upgrades);
    loadGame();
    sanitizeUpgrades(upgrades);
    initUI();
    updateUI_throttled(true);

    const FIXED_DT = 0.05;
    let accumulator = 0;
    let lastTime = performance.now();

    function simulateStep(dt){
      const s = speedMultiplier;
      for (let i=0;i<upgrades.length;i++){
        const u = upgrades[i];
        prevProgress[i] = currProgress[i];
        let progRate = NaN;
        try { progRate = (u._rateBN && typeof u._rateBN.toNumberSafe === 'function') ? u._rateBN.toNumberSafe() : NaN; } catch(e){ progRate = NaN; }
        // apply global r multiplier here for progression speed
        if (!isFinite(progRate) || progRate <= 0) progRate = (u.baseRate || 0.01);
        progRate *= (globalPrestige.rMul || 1);
        let incProg = progRate * dt * 100 * s;
        if (!isFinite(incProg)) incProg = 0;
        currProgress[i] += incProg;
        if (currProgress[i] > PROGRESS_CAP) currProgress[i] = PROGRESS_CAP;
        if (currProgress[i] >= 100){
          let completed = Math.floor(currProgress[i] / 100);
          if (completed > 1000000) completed = 1000000;
          currProgress[i] -= completed * 100;
          const incBaseBN = getMultiplierIncrementBig(u);
          incBaseBN.mulByNumber(completed);
          u._multBN.addInPlace(incBaseBN);
          if (u._multBN.e > 300) u._multBN = BigNum.fromNumber(1e300);
        }
        u.progress = currProgress[i];
      }

      let totalMultBN = BigNum.fromNumber(1);
      for (let i=0;i<upgrades.length;i++){
        const u = upgrades[i];
        const pMult = 0.02 * ((u.prestigeLevel && u.prestigeLevel.mult) || 0);
        const asc = 0.05 * (u.ascendCount || 0);
        const factorBN = BigNum.fromNumber(1);
        factorBN.addInPlace(u._multBN);
        factorBN.addNumber(pMult + asc + (globalPrestige.mAdd || 0));
        totalMultBN.mulInPlace(factorBN);
      }

      const addBN = baseIncome.clone();
      addBN.mulInPlace(totalMultBN);
      addBN.mulByNumber(dt * s);
      money.addInPlace(addBN);
      if (money.e > 1000) money = BigNum.fromNumber(1e300);
    }

    function render(){
      const now = performance.now();
      let frameDelta = (now - lastTime) / 1000;
      if (!isFinite(frameDelta) || frameDelta <= 0) frameDelta = 0;
      lastTime = now;
      if (frameDelta > 0.5) frameDelta = 0.5;
      accumulator += frameDelta;
      if (accumulator > 0.5) accumulator = 0.5;

      if (!paused){
        while (accumulator >= FIXED_DT){
          simulateStep(FIXED_DT);
          accumulator -= FIXED_DT;
        }
      } else {
        accumulator = 0;
        for (let i=0;i<upgrades.length;i++) prevProgress[i] = currProgress[i];
      }

      const alpha = FIXED_DT === 0 ? 0 : (accumulator / FIXED_DT);

      if (money.m === 0){
        displayMoneyNum += (0 - displayMoneyNum) * 0.12;
        document.getElementById('money').textContent = fmtSmall(displayMoneyNum);
      } else if (money.e <= 12){
        const v = money.toNumberSafe();
        if (isFinite(v)){
          displayMoneyNum += (v - displayMoneyNum) * 0.12;
          document.getElementById('money').textContent = fmtSmall(displayMoneyNum);
        } else {
          document.getElementById('money').textContent = money.toString();
        }
      } else {
        document.getElementById('money').textContent = money.toString();
      }

      for (let i=0;i<upgrades.length;i++){
        const interp = prevProgress[i] + (currProgress[i] - prevProgress[i]) * alpha;
        const w = Math.min(Math.max(interp, 0), 100);
        const el = upgradeUI[i] && upgradeUI[i].fillEl;
        if (el){
          const scale = Math.max(0, Math.min(1, w / 100));
          el.style.transform = 'scaleX(' + scale + ')';
        }
      }

      updateUI_throttled();
      requestAnimationFrame(render);
    }

    requestAnimationFrame(render);

    // wiring
    // ensure doPrestige exists before wiring the button
    const prestigeBtn = document.getElementById('prestigeBtn');
    prestigeBtn.addEventListener('click', ()=> doPrestige(false));

    const inftyBtn = document.getElementById('gainInfinityBtn');
    if (inftyBtn) inftyBtn.addEventListener('click', gainInfinity);
    window.addEventListener('beforeunload', ()=> saveGame());

    // attach reset handler -> FULL reset in-memory + save removed
    const resetBtn = document.getElementById('resetBtn');
    resetBtn.addEventListener('click', ()=> {
      if (!confirm('æœ¬å½“ã«ã‚»ãƒ¼ãƒ–ã‚’å‰Šé™¤ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å®Œå…¨ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return;
      fullReset();
      alert('ã‚²ãƒ¼ãƒ ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã‚»ãƒ¼ãƒ–ã‚‚å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã€‚');
    });

    // auto-buy
    setInterval(function(){
      try {
        const autoOn = document.getElementById('autoToggle').checked && prestigeCount >= 1;
        if (!autoOn) return;
        const qty = document.getElementById('autoQty').value;
        const order = upgrades.map((u,i)=>({i,c:getUpgradeCostBig(u)})).sort((a,b)=>{
          if (a.c.e !== b.c.e) return a.c.e - b.c.e;
          return Math.abs(a.c.m) - Math.abs(b.c.m);
        });
        for (let k=0;k<order.length;k++){
          const entry = order[k];
          // skip if at level cap
          if (upgrades[entry.i].level >= getLevelCap(upgrades[entry.i])) continue;
          if (money.gteBig(entry.c)){
            buyUpgrade(entry.i, qty, true); // silent auto-buy
            break;
          }
        }
      } catch(e){ console.warn('auto-buy error', e); }
    }, 900);

    // speed UI
    const speedSelect = document.getElementById('speedSelect');
    const speedInc = document.getElementById('speedInc');
    const speedDec = document.getElementById('speedDec');
    const pauseBtn = document.getElementById('pauseBtn');
    function clampSpeed(v){ return Math.max(1, Math.min(3, Math.round(v))); }
    function updateSpeedUI(force){
      speedMultiplier = clampSpeed(speedMultiplier);
      speedSelect.value = String(speedMultiplier);
      pauseBtn.textContent = paused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢';
      if (force) updateUI_throttled(true);
      saveGame();
    }
    speedSelect.addEventListener('change', ()=> { speedMultiplier = clampSpeed(Number(speedSelect.value)); updateSpeedUI(true); });
    speedInc.addEventListener('click', ()=> { speedMultiplier = clampSpeed(speedMultiplier + 1); updateSpeedUI(true); });
    speedDec.addEventListener('click', ()=> { speedMultiplier = clampSpeed(speedMultiplier - 1); updateSpeedUI(true); });
    pauseBtn.addEventListener('click', ()=> { paused = !paused; if (paused) accumulator = 0; updateSpeedUI(true); });
    window.addEventListener('keydown', (e) => {
      if (e.key === '['){ speedMultiplier = clampSpeed(speedMultiplier - 1); updateSpeedUI(true); e.preventDefault(); }
      else if (e.key === ']'){ speedMultiplier = clampSpeed(speedMultiplier + 1); updateSpeedUI(true); e.preventDefault(); }
      else if (e.code === 'Space'){ paused = !paused; if (paused) accumulator = 0; updateSpeedUI(true); e.preventDefault(); }
    });

    updateSpeedUI(true);

    // ===== Prestige shop UI & logic =====
    const prestigeShopItems = [
      { id:'m_add', title:'å…¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ m +0.01', cost:2, apply(){ globalPrestige.mAdd += 0.01; } },
      { id:'r_mul', title:'å…¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ r Ã—1.05', cost:3, apply(){ globalPrestige.rMul *= 1.05; } },
      { id:'cost_dec', title:'å…¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ ã‚³ã‚¹ãƒˆ -10%', cost:4, apply(){ globalPrestige.costMul *= 0.90; } },
      { id:'costGrowth_down', title:'ã‚³ã‚¹ãƒˆæˆé•·ç‡ã‚’-0.01', cost:6, apply(){ costBaseMultVar = Math.max(1.01, costBaseMultVar - 0.01); } },
    ];

    function renderPrestigeShop(){
      const shop = document.getElementById('prestigeShop');
      if (!shop) return;
      shop.innerHTML = '';
      const info = document.createElement('div'); info.className='card'; info.textContent = 'ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆ: ' + prestigePoints; shop.appendChild(info);
      prestigeShopItems.forEach(item => {
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<div><strong>${item.title}</strong></div><div class="small">Cost: ${item.cost} pts</div>`;
        const btn = document.createElement('button'); btn.className='btn btn-small'; btn.textContent='Buy';
        btn.addEventListener('click', ()=>{
          if (prestigePoints >= item.cost){
            prestigePoints -= item.cost;
            item.apply();
            saveGame();
            updateUI_throttled(true);
            alert('è³¼å…¥ã—ã¾ã—ãŸ: ' + item.title);
          } else alert('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“');
        });
        card.appendChild(btn);
        shop.appendChild(card);
      });
    }

    // ===== Debug URL ?= support (keeps from earlier) =====
    (function() {
      const params = window.location.search;
      const match = params.match(/\?=(.+)/);
      if (!match) return;
      const command = match[1];
      console.log("DEBUG MODE:", command);
      const [key, value] = command.split(":");
      switch (key) {
        case "prestige":
          money = BigNum.fromNumber(1e21);
          updateUI_throttled(true);
          alert("ãƒ‡ãƒãƒƒã‚°: ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸æ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸ");
          break;
        case "infinity":
          money = BigNum.fromMantExp(1.8,308);
          updateUI_throttled(true);
          alert("ãƒ‡ãƒãƒƒã‚°: ç„¡é™æ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸ");
          break;
        case "ascend":
          upgrades.forEach(u => u.level = getLevelCap(u));
          updateUI_throttled(true);
          alert("ãƒ‡ãƒãƒƒã‚°: å…¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’Lvä¸Šé™ã«ã—ã¾ã—ãŸ");
          break;
        case "money":
          money = BigNum.fromNumber(Number(value) || 1e10);
          updateUI_throttled(true);
          alert("ãƒ‡ãƒãƒƒã‚°: æ‰€æŒé‡‘ã‚’ " + value + " ã«è¨­å®šã—ã¾ã—ãŸ");
          break;
        case "reset":
          if (confirm("æœ¬å½“ã«å…¨ã¦ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
            fullReset();
            alert("ãƒ‡ãƒãƒƒã‚°: ã‚»ãƒ¼ãƒ–ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
          }
          break;
        default:
          alert("ä¸æ˜ãªãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰: " + command);
      }
    })();

  } catch(err){
    showError(err && err.message ? err.message : String(err));
  }
})();
</script>
</body>
</html>
