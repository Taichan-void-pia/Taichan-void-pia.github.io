<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ  â€” æ˜‡å¤© & è»¢ç”Ÿå¼·åŒ–ç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:"Segoe UI",sans-serif;background:#071018;color:#fff;text-align:center;margin:0;padding:18px}
  h1{color:#7bf3a8;text-shadow:0 0 10px rgba(123,243,168,0.12)}
  .stats{margin:10px auto;padding:10px 14px;background:rgba(255,255,255,0.03);border-radius:10px;width:96%;max-width:960px}
  .money{font-size:1.5em;color:#7bf3a8;font-weight:700}
  .formula{font-size:0.9em;color:#cfe8da;margin-top:6px}
  #upgradeContainer{width:96%;max-width:1100px;margin:12px auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
  .upgrade{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:8px;padding:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
  .meter{background:rgba(255,255,255,0.04);height:16px;border-radius:8px;overflow:hidden;margin:8px 0}
  .fill{height:100%;background:linear-gradient(90deg,#7bf3a8,#39d092);width:0%;transition:width 0.12s linear}
  button{border:none;border-radius:6px;padding:6px 10px;font-weight:700;cursor:pointer}
  .btn-buy{background:linear-gradient(90deg,#7bf3a8,#39d092);color:#00221a}
  .btn-small{background:rgba(255,255,255,0.03);color:#cfe8da;padding:4px 8px}
  .panel{width:96%;max-width:1100px;margin:10px auto;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
  .small{font-size:0.85em;color:#cfe8da}
  .prestige{background:linear-gradient(90deg,#ffd86b,#ff9f43);color:#2b1400;border-radius:8px;padding:8px 12px;font-weight:800;cursor:pointer}
  input[type="checkbox"]{transform:scale(1.05);margin-left:6px}
  select{padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);color:#cfe8da}
</style>
</head>
<body>
  <h1>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ  â€” æ˜‡å¤© & è»¢ç”Ÿå¼·åŒ–ç‰ˆ</h1>

  <div class="stats">
    <div>æ‰€æŒé‡‘ï¼š<span id="money" class="money">0</span></div>
    <div>ç§’ã‚ãŸã‚Šåå…¥ï¼š<span id="rate">0</span></div>
    <div class="formula" id="formula">(è¨ˆç®—å¼)</div>
    <div class="small">è»¢ç”Ÿå›æ•°ï¼š<span id="prestigeCount">0</span>ã€€/ã€€è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆï¼š<span id="prestigePoints">0</span>ã€€/ã€€å…¨æ°¸ç¶šå€ç‡ï¼šÃ—<span id="prestigeMult">1</span></div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="globalPrestigeBtn" class="prestige">âœ¨ è»¢ç”Ÿï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰</button>
        <div class="small">åˆå›ã¯ <b>1e20</b> ä»¥ä¸Šã§è§£ç¦ã€‚2å›ç›®ä»¥é™ã¯å‰å›è»¢ç”Ÿæ™‚ã‚¹ã‚³ã‚¢ä»¥ä¸ŠãŒå¿…è¦ã€‚</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label>Auto-Buy (è»¢ç”Ÿæ¸ˆã§æœ‰åŠ¹): </label>
        <select id="autoQty"><option value="1">Ã—1</option><option value="10">Ã—10</option><option value="100">Ã—100</option><option value="max">Ã—Max</option></select>
        <label class="small">æœ‰åŠ¹ <input id="autoToggle" type="checkbox" /></label>
      </div>
    </div>
  </div>

  <div id="upgradeContainer"></div>

  <div class="panel" id="prestigeUpgradePanel">
    <h3 style="margin:6px 0">æ°¸ç¶šï¼ˆPrestigeï¼‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆå„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã”ã¨ï¼‰</h3>
    <div class="small">å„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ <b>æ°¸ç¶šï¼šmult / rate / cost</b> ã®ã„ãšã‚Œã‹ã‚’è³¼å…¥ã§ãã¾ã™ï¼ˆã‚³ã‚¹ãƒˆã¯1PPã‹ã‚‰å¢—åŠ ï¼‰ã€‚</div>
    <div id="prestigeUpgradeContainer" style="margin-top:8px"></div>
  </div>

<script>
/* ===========================
  è¨­å®š/ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ10å€‹ï¼‰ â€” æˆé•·æ›²ç·šã‚’ç·©ã‚„ã‹ã«
  =========================== */
const upgradesTemplate = [
  { name:"åå…¥ã‚¢ãƒƒãƒ—", baseRate:0.9, rate:0.9, mult:0, speedMult:1.18, baseCost:12, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"åŠ¹ç‡ã‚¢ãƒƒãƒ—", baseRate:0.6, rate:0.6, mult:0, speedMult:1.16, baseCost:40, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"è‡ªå‹•è²©å£²æ©Ÿ", baseRate:0.45, rate:0.45, mult:0, speedMult:1.14, baseCost:120, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"éŠ€è¡ŒæŠ•è³‡", baseRate:0.3, rate:0.3, mult:0, speedMult:1.12, baseCost:520, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"AIç”Ÿæˆå·¥å ´", baseRate:0.18, rate:0.18, mult:0, speedMult:1.10, baseCost:2200, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },

  { name:"ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", baseRate:0.14, rate:0.14, mult:0, speedMult:1.09, baseCost:12000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"ç ”ç©¶æ‰€", baseRate:0.11, rate:0.11, mult:0, speedMult:1.085, baseCost:60000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"æƒ‘æ˜Ÿé–‹ç™º", baseRate:0.08, rate:0.08, mult:0, speedMult:1.07, baseCost:250000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"é‡å­ã‚µãƒ¼ãƒãƒ¼", baseRate:0.05, rate:0.05, mult:0, speedMult:1.055, baseCost:1200000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
  { name:"æ¬¡å…ƒã‚³ã‚¢", baseRate:0.02, rate:0.02, mult:0, speedMult:1.04, baseCost:6000000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
];

function cloneTemplate(){ return JSON.parse(JSON.stringify(upgradesTemplate)); }

/* ===========================
  ã‚²ãƒ¼ãƒ çŠ¶æ…‹
  =========================== */
let money = 0;
let baseIncome = 1;
let upgrades = cloneTemplate();
let prestigePoints = 0;    // é€šå¸¸ã®è»¢ç”Ÿã§å¾—ã‚‹ãƒã‚¤ãƒ³ãƒˆï¼ˆæ°¸ç¶šLvã«ä½¿ã†ï¼‰
let prestigeCount = 0;     // ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿå›æ•°ï¼ˆè‡ªå‹•è³¼å…¥ã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¤å®šï¼‰
let prestigeMult = 1;      // å…¨ä½“ã«ã‹ã‹ã‚‹æ°¸ç¶šå€ç‡ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿã§å¢—åŠ ï¼‰
let lastGlobalPrestigeScore = 0; // ç›´è¿‘ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿæ™‚ã®ã‚¹ã‚³ã‚¢ï¼ˆæ¬¡å›ä»¥é™ã®ä¸‹é™ï¼‰
const COST_POW = 1.5;      // ã‚³ã‚¹ãƒˆã®æˆé•·æ›²ç·šï¼ˆç·©ã‚„ã‹ï¼‰

/* ===========================
  DOM ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  =========================== */
const upgradeUI = [];

/* ===========================
  ãƒ˜ãƒ«ãƒ‘ãƒ¼
  =========================== */
function fmt(n){
  if (typeof n !== 'number') return String(n);
  if (!isFinite(n)) return "Infinity";
  const a = Math.abs(n);
  if (a >= 1e15) return n.toExponential(2);
  if (a >= 1e9) return (n/1e9).toFixed(2) + "B";
  if (a >= 1e6) return (n/1e6).toFixed(2) + "M";
  return Math.floor(n).toLocaleString();
}
function getUpgradeCost(u){
  // ç·©ã‚„ã‹ãªå¢—åŠ ï¼š baseCost * (level+1)^COST_POW * costReduction
  const raw = Math.floor(u.baseCost * Math.pow(u.level + 1, COST_POW));
  const reduction = 1 - 0.03 * (u.prestigeLevel?.cost || 0); // 3% per cost prestige level
  return Math.max(1, Math.floor(raw * Math.max(reduction, 0.5))); // cost floor and min 50% cost
}

/* ===========================
  UI åˆæœŸåŒ–
  =========================== */
function initUI(){
  const container = document.getElementById("upgradeContainer");
  container.innerHTML = "";
  upgrades.forEach((u,i)=>{
    const div = document.createElement("div");
    div.className = "upgrade";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${i+1}. ${u.name}</strong>
        <div class="small">Lv <span id="lvl${i}">0</span></div>
      </div>
      <div class="small">æ˜‡å¤©å›æ•°: <span id="asc${i}">0</span></div>
      <div class="small">æ°¸ç¶šLv (mult/rate/cost): <span id="pLv${i}">0</span>/<span id="pLvR${i}">0</span>/<span id="pLvC${i}">0</span></div>
      <div class="small" style="margin-top:6px">ä¹—æ•°åˆè¨ˆ: <span id="mult${i}">+0.000</span></div>
      <div class="small">ãƒ¡ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦: <span id="rate${i}">${u.rate.toFixed(2)}</span> /s</div>
      <div class="meter"><div id="fill${i}" class="fill" style="width:0%"></div></div>
      <div style="display:flex;gap:6px;justify-content:center;margin-top:6px;flex-wrap:wrap">
        <button id="buy1_${i}" class="btn-buy">è³¼å…¥ï¼ˆ<span id="cost${i}">0</span>ï¼‰</button>
        <button id="buy10_${i}" class="btn-small">Ã—10</button>
        <button id="buy100_${i}" class="btn-small">Ã—100</button>
        <button id="buyMax_${i}" class="btn-small">Ã—Max</button>
        <button id="ascend_${i}" class="btn-small">æ˜‡å¤©</button>
      </div>
    `;
    container.appendChild(div);

    upgradeUI[i] = {
      root: div,
      fillEl: document.getElementById("fill"+i),
      lvlEl: document.getElementById("lvl"+i),
      costEl: document.getElementById("cost"+i),
      multEl: document.getElementById("mult"+i),
      rateEl: document.getElementById("rate"+i),
      ascEl: document.getElementById("asc"+i),
      pLvEl: document.getElementById("pLv"+i),
      pLvREl: document.getElementById("pLvR"+i),
      pLvCEl: document.getElementById("pLvC"+i),
      btn1: document.getElementById("buy1_"+i),
      btn10: document.getElementById("buy10_"+i),
      btn100: document.getElementById("buy100_"+i),
      btnMax: document.getElementById("buyMax_"+i),
      btnAsc: document.getElementById("ascend_"+i),
    };

    upgradeUI[i].btn1.addEventListener('click', ()=> buyUpgrade(i,1));
    upgradeUI[i].btn10.addEventListener('click', ()=> buyUpgrade(i,10));
    upgradeUI[i].btn100.addEventListener('click', ()=> buyUpgrade(i,100));
    upgradeUI[i].btnMax.addEventListener('click', ()=> buyUpgrade(i,"max"));
    upgradeUI[i].btnAsc.addEventListener('click', ()=> tryAscend(i));
  });

  // prestige-upgrade panel
  const pcont = document.getElementById("prestigeUpgradeContainer");
  pcont.innerHTML = "";
  upgrades.forEach((u,i)=>{
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "center";
    row.style.marginTop = "6px";
    row.innerHTML = `
      <div class="small">${i+1}. ${u.name}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="small">mult cost: <span id="pmCost${i}">1</span> PP</div>
        <button id="pmBuy${i}" class="btn-small">mult +1</button>
        <div class="small">rate cost: <span id="prCost${i}">1</span> PP</div>
        <button id="prBuy${i}" class="btn-small">rate +1</button>
        <div class="small">cost cost: <span id="pcCost${i}">1</span> PP</div>
        <button id="pcBuy${i}" class="btn-small">cost +1</button>
      </div>
    `;
    pcont.appendChild(row);
    document.getElementById("pmBuy"+i).addEventListener('click', ()=> buyPrestigeType(i,'mult'));
    document.getElementById("prBuy"+i).addEventListener('click', ()=> buyPrestigeType(i,'rate'));
    document.getElementById("pcBuy"+i).addEventListener('click', ()=> buyPrestigeType(i,'cost'));
  });
}

/* ===========================
  UI æ›´æ–°ï¼ˆå·®åˆ†ãƒ»100msé–“éš”ï¼‰
  =========================== */
let lastUI = 0;
function updateUI(force=false){
  const now = performance.now();
  if (!force && now - lastUI < 100) return;
  lastUI = now;

  document.getElementById("money").textContent = fmt(money);
  const totalMult = upgrades.reduce((acc,u)=>{
    const prestBonus = (u.prestigeLevel?.mult || 0) * 0.02; // 2% per mult prestige level
    const ascBonus = u.ascendCount * 0.05; // 5% per ascend
    return acc * (1 + u.mult + prestBonus + ascBonus);
  }, 1) * prestigeMult;
  document.getElementById("rate").textContent = (baseIncome * totalMult).toFixed(2);
  document.getElementById("formula").textContent = `åå…¥ = ${baseIncome} Ã— ` +
    upgrades.map(u=>`(1+${(u.mult + (u.prestigeLevel?.mult||0)*0.02 + u.ascendCount*0.05).toFixed(3)})`).join(" Ã— ") +
    ` Ã— ${prestigeMult.toFixed(2)}`;

  document.getElementById("prestigePoints").textContent = prestigePoints;
  document.getElementById("prestigeCount").textContent = prestigeCount;
  document.getElementById("prestigeMult").textContent = prestigeMult.toFixed(2);

  upgrades.forEach((u,i)=>{
    const ui = upgradeUI[i];
    if (!ui) return;
    ui.lvlEl.textContent = u.level;
    ui.costEl.textContent = fmt(getUpgradeCost(u));
    ui.multEl.textContent = `+${u.mult.toFixed(3)}`;
    ui.rateEl.textContent = u.rate.toFixed(2);
    ui.fillEl.style.width = Math.min(u.progress,100) + "%";
    ui.ascEl.textContent = u.ascendCount;
    ui.pLvEl.textContent = u.prestigeLevel?.mult || 0;
    ui.pLvREl.textContent = u.prestigeLevel?.rate || 0;
    ui.pLvCEl.textContent = u.prestigeLevel?.cost || 0;

    // ascend button enabled if level >= 100*(ascendCount+1)
    ui.btnAsc.disabled = !(u.level >= 100 * (u.ascendCount + 1));
  });

  // auto-buy toggle availability
  const autoToggle = document.getElementById("autoToggle");
  autoToggle.disabled = prestigeCount < 1;
  if (autoToggle.disabled) autoToggle.checked = false;

  // global prestige enable: first allowed at 1e20, later require lastGlobalPrestigeScore or greater
  const gbtn = document.getElementById("globalPrestigeBtn");
  const canGlobal = (money >= 1e20 && (prestigeCount === 0 || money >= lastGlobalPrestigeScore));
  gbtn.disabled = !canGlobal;
}

/* ===========================
  è³¼å…¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¤‡æ•° / Max å¯¾å¿œï¼‰
  =========================== */
function costToBuy(u, n){
  if (n <= 0) return 0;
  const base = u.baseCost;
  const start = u.level + 1;
  let total = 0;
  for (let k = 0; k < n; k++){
    const raw = Math.floor(base * Math.pow(start + k, COST_POW));
    const reduction = 1 - 0.03 * (u.prestigeLevel?.cost || 0);
    total += Math.max(1, Math.floor(raw * Math.max(reduction, 0.5)));
    if (total > 1e308) return Infinity;
  }
  return total;
}
function buyUpgrade(idx, qty){
  const u = upgrades[idx];
  if (qty === "max"){
    // binary search
    let lo = 0, hi = 1;
    while (costToBuy(u,hi) <= money && hi < 1e9) hi *= 2;
    while (lo + 1 < hi){
      const mid = Math.floor((lo + hi) / 2);
      if (costToBuy(u, mid) <= money) lo = mid;
      else hi = mid;
    }
    if (lo > 0) doPurchase(u, idx, lo);
    else alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }
  const n = Number(qty) || 1;
  const c = costToBuy(u, n);
  if (c <= money) doPurchase(u, idx, n);
  else alert("ãã®æ•°ã¯è²·ãˆã¾ã›ã‚“ï¼ˆãŠé‡‘ä¸è¶³ï¼‰ã€‚");
}
function doPurchase(u, idx, n){
  const c = costToBuy(u, n);
  money -= c;
  u.level += n;
  // rate increase modestly: speedMult^(n*0.4) to be gentler
  u.rate *= Math.pow(Math.max(1, u.speedMult), n * 0.4);
  saveGame();
  updateUI(true);
}

/* ===========================
  ãƒ¡ãƒ¼ã‚¿ãƒ¼æº€ã‚¿ãƒ³å‡¦ç†ï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
  - ä¹—æ•°å¢—åˆ†ã‚’ç·©ã‚„ã‹ã«ï¼šåŸºæœ¬ 0.004 * (1 + level)^0.45
  - æ°¸ç¶š (prestige mult) ãŠã‚ˆã³ ascendCount ã‚’è€ƒæ…®
  =========================== */
function getMultiplierIncrement(u){
  return 0.004 * Math.pow(1 + u.level, 0.45);
}

/* ===========================
  æ˜‡å¤©ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å°‚ç”¨ã®å°è»¢ç”Ÿï¼‰
  - è¦ä»¶: level >= 100*(ascendCount+1)
  - åŠ¹æœ: ascendCount++, æ°¸ç¶šçš„ã« (multãŠã‚ˆã³rate) ã‚’ +5% per ascend
  - ãƒªã‚»ãƒƒãƒˆ: level=0, progress=0
  =========================== */
function tryAscend(i){
  const u = upgrades[i];
  const need = 100 * (u.ascendCount + 1);
  if (u.level < need) { alert(`Lv ${need} ãŒå¿…è¦ã§ã™ï¼ˆç¾åœ¨ Lv ${u.level}ï¼‰ã€‚`); return; }
  if (!confirm(`${u.name} ã‚’æ˜‡å¤©ã—ã¾ã™ã‹ï¼ŸLvãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ãŒã€æ˜‡å¤©åŠ¹æœï¼ˆä¹—æ•°ã¨é€Ÿåº¦+5%ï¼‰ãŒæ°¸ä¹…ä»˜ä¸ã•ã‚Œã¾ã™ã€‚`)) return;
  u.ascendCount++;
  // apply immediate small bonus by multiplying existing mult/rate slightly (permanent effect taken into account in formulas)
  // Reset level/progress to force regrind
  u.level = 0;
  u.progress = 0;
  saveGame();
  updateUI(true);
  alert(`${u.name} ã‚’æ˜‡å¤©ã—ã¾ã—ãŸï¼ˆæ˜‡å¤©å›æ•°: ${u.ascendCount}ï¼‰ã€‚`);
}

/* ===========================
  æ°¸ç¶šã‚¿ã‚¤ãƒ—è³¼å…¥ï¼ˆmult/rate/costï¼‰
  - cost: currentLevelOfThatType + 1 (in prestigePoints)
  - effects:
     * mult: each adds +2% to income multiplier (applied when computing total)
     * rate: each adds +5% to that upgrade's rate
     * cost: each reduces cost by 3% (stack), min 50%
  =========================== */
function buyPrestigeType(idx, type){
  const u = upgrades[idx];
  const current = u.prestigeLevel[type] || 0;
  const cost = current + 1;
  if (prestigePoints < cost) { alert("è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
  prestigePoints -= cost;
  u.prestigeLevel[type] = current + 1;
  // apply immediate effect to rate/cost where applicable
  if (type === 'rate') {
    u.rate *= 1 + 0.05; // +5% immediately
  }
  saveGame();
  updateUI(true);
}

/* ===========================
  ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿï¼ˆå…¨ä½“ï¼‰
  - åˆå›: money >= 1e20
  - ä»¥é™: money >= lastGlobalPrestigeScore (prev prestige score)
  - effect:
    * prestigePoints += 1
    * prestigeCount += 1
    * prestigeMult *= (1 + log10(score / 1e20)), where score is the money at prestige
    * reset money & upgrades (but keep per-upgrade prestigeLevel and ascendCount? user wanted æ°¸ç¶šãƒã‚¤ãƒ³ãƒˆä¿æŒ; we keep prestigeLevel but reset level & progress)
    * enforce second prestige condition: money must be >= previous prestige score
  =========================== */
function doGlobalPrestige(force=false){
  if (!force){
    if (!(money >= 1e20)) { alert("è»¢ç”Ÿæ¡ä»¶: ã‚¹ã‚³ã‚¢ãŒ 1e20 ä»¥ä¸Šå¿…è¦ã§ã™ã€‚"); return; }
    if (prestigeCount > 0 && money < lastGlobalPrestigeScore) { alert(`å‰å›è»¢ç”Ÿæ™‚ã®ã‚¹ã‚³ã‚¢ ${fmt(lastGlobalPrestigeScore)} ä»¥ä¸Šã§ãªã„ã¨å†è»¢ç”Ÿã§ãã¾ã›ã‚“ã€‚`); return; }
    if (!confirm("ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ æ‰€æŒé‡‘ã¨é€šå¸¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼ˆæ°¸ç¶šLvã¯ä¿æŒï¼‰ã€‚")) return;
  }
  // compute multiplier bonus from distance
  const score = money;
  let extra = 1;
  if (score >= 1e20) {
    extra = 1 + Math.log10(score / 1e20); // score=1e20 -> extra=1 ; score=1e21 -> extra=2
    if (!isFinite(extra) || extra < 1) extra = 1;
  }
  prestigePoints += 1;
  prestigeCount += 1;
  prestigeMult *= extra;
  lastGlobalPrestigeScore = score;
  // reset money and upgrade levels/progress but keep prestigeLevel and ascendCount
  money = 0;
  upgrades.forEach((u,i)=>{
    u.level = 0;
    u.progress = 0;
    // keep u.prestigeLevel and u.ascendCount
  });
  initUI();
  saveGame();
  updateUI(true);
  alert(`ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿå®Œäº†ï¼ æ°¸ç¶šãƒã‚¤ãƒ³ãƒˆ +1ã€‚åå…¥å€ç‡ Ã—${extra.toFixed(2)} ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`);
}

/* ===========================
  è‡ªå‹•è³¼å…¥ (Auto-Buy)
  - æœ‰åŠ¹æ™‚ã‹ã¤ prestigeCount >=1 ã§æ©Ÿèƒ½
  - strategy: cheapest purchasable upgrade first (selected qty)
  =========================== */
setInterval(()=>{
  const enabled = document.getElementById("autoToggle").checked && prestigeCount >= 1;
  if (!enabled) return;
  const qty = document.getElementById("autoQty").value;
  // choose upgrades sorted by current cost ascending
  const order = upgrades.map((u,i)=>({i,c:getUpgradeCost(u)})).sort((a,b)=>a.c-b.c);
  for (const entry of order){
    if (getUpgradeCost(upgrades[entry.i]) <= money){
      buyUpgrade(entry.i, qty);
      break; // buy one per tick to avoid heavy spending - can be tuned
    }
  }
}, 800);

/* ===========================
  ã‚»ãƒ¼ãƒ– / ãƒ­ãƒ¼ãƒ‰
  =========================== */
function saveGame(){
  try {
    const save = {
      money, baseIncome, upgrades, prestigePoints, prestigeCount, prestigeMult, lastGlobalPrestigeScore
    };
    localStorage.setItem("idleAscendSave_vFinal", JSON.stringify(save));
  } catch(e){ console.warn("save failed", e); }
}
function loadGame(){
  try {
    const raw = localStorage.getItem("idleAscendSave_vFinal");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (typeof data.money === 'number') money = data.money;
    if (typeof data.baseIncome === 'number') baseIncome = data.baseIncome;
    if (Array.isArray(data.upgrades) && data.upgrades.length === upgradesTemplate.length) upgrades = data.upgrades;
    if (typeof data.prestigePoints === 'number') prestigePoints = data.prestigePoints;
    if (typeof data.prestigeCount === 'number') prestigeCount = data.prestigeCount;
    if (typeof data.prestigeMult === 'number') prestigeMult = data.prestigeMult;
    if (typeof data.lastGlobalPrestigeScore === 'number') lastGlobalPrestigeScore = data.lastGlobalPrestigeScore;
  } catch(e){ console.warn("load failed", e); }
}

/* ===========================
  ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€é©åŒ–ï¼‰
  =========================== */
initUI();
loadGame();
updateUI(true);

let last = Date.now();
function loop(){
  const now = Date.now();
  let delta = (now - last) / 1000;
  last = now;
  if (!isFinite(delta) || delta <= 0) delta = 0;
  const MAX_DELTA = 1.0;
  if (delta > MAX_DELTA) delta = MAX_DELTA;

  upgrades.forEach(u=>{
    // progress increases: rate * delta * 100 (%)
    u.progress += u.rate * delta * 100;
    if (u.progress >= 100){
      let completed = Math.floor(u.progress / 100);
      const MAX_COMPLETED = 1e6;
      if (completed > MAX_COMPLETED) completed = MAX_COMPLETED;
      u.progress -= completed * 100;
      // increment based on level and prestige mult
      const incBase = getMultiplierIncrement(u);
      // multPrestige increases multiplier increment slightly
      const multPrestBonus = 1 + 0.02 * (u.prestigeLevel?.mult || 0);
      const ascBonus = u.ascendCount * 0.05;
    return acc * (1 + u.mult + pBonus + ascBonus);
  }, 1) * prestigeMult;

  money += baseIncome * totalMult * delta;

  updateUI();

  if (Date.now() % 5000 < 40) saveGame();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===========================
  ãƒ˜ãƒ«ãƒ—: Global prestige button & wiring
  =========================== */
document.getElementById("globalPrestigeBtn").addEventListener('click', ()=> doGlobalPrestige(false));
window.addEventListener('beforeunload', ()=> saveGame());

/* ===========================
  ãƒ‡ãƒãƒƒã‚°ç”¨URLã‚µãƒãƒ¼ãƒˆ:
  ?money=1e20 ãªã©
  ?forceGlobal=1 to force global prestige
  =========================== */
const params = new URLSearchParams(location.search);
if (params.get("money")){
  const m = Number(params.get("money"));
  money = isFinite(m) ? m : Number(params.get("money"));
  updateUI(true);
}
if (params.get("forceGlobal")==="1") setTimeout(()=> doGlobalPrestige(true), 200);
</script>
</body>
</html>
