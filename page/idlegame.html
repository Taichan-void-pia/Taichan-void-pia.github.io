<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ ï¼ˆæ”¹ â€” è»¢ç”Ÿãƒ»è‡ªå‹•è³¼å…¥ãƒ»è¤‡æ•°è³¼å…¥ï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:"Segoe UI",sans-serif;background:#0b0f12;color:#fff;text-align:center;margin:0;padding:20px}
  h1{color:#7bf3a8;text-shadow:0 0 12px rgba(123,243,168,0.15)}
  .stats{margin:12px auto;padding:12px 18px;background:rgba(255,255,255,0.04);border-radius:12px;width:96%;max-width:720px}
  .money{font-size:1.6em;color:#7bf3a8;font-weight:700}
  .formula{font-size:0.9em;color:#cfe8da;margin-top:6px}
  #upgradeContainer{width:96%;max-width:920px;margin:12px auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
  .upgrade{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
  .meter{background:rgba(255,255,255,0.06);height:16px;border-radius:8px;overflow:hidden;margin:8px 0}
  .fill{height:100%;background:linear-gradient(90deg,#7bf3a8,#43d6a0);width:0%;transition:width 0.12s linear}
  button{border:none;border-radius:6px;padding:6px 10px;font-weight:700;cursor:pointer}
  .btn-buy{background:linear-gradient(90deg,#7bf3a8,#43d6a0);color:#00221a}
  .btn-small{background:rgba(255,255,255,0.04);color:#dff8ee;margin-left:6px;padding:4px 8px;font-weight:600}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .prestige{background:linear-gradient(90deg,#ffd86b,#ff9f43);color:#1a1200;border-radius:8px;padding:10px 14px;font-weight:800;cursor:pointer}
  .small{font-size:0.85em;color:#cfe8da}
  .panel{width:96%;max-width:920px;margin:10px auto;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
  label{font-size:0.9em;color:#cfe8da}
  input[type="checkbox"]{transform:scale(1.1);margin-left:6px}
</style>
</head>
<body>
  <h1>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ  â€” æ”¹è‰¯ç‰ˆ</h1>

  <div class="stats">
    <div>æ‰€æŒé‡‘ï¼š<span id="money" class="money">0</span></div>
    <div>ç§’ã‚ãŸã‚Šåå…¥ï¼š<span id="rate">0</span></div>
    <div class="formula" id="formula">(è¨ˆç®—å¼)</div>
    <div class="small">è»¢ç”Ÿå›æ•°ï¼š<span id="prestigeCount">0</span>ã€€/ã€€è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆï¼š<span id="prestigePoints">0</span>ã€€/ã€€æ°¸ç¶šå€ç‡ï¼šÃ—<span id="prestigeMult">1</span></div>
  </div>

  <div class="panel">
    <div class="row">
      <button id="prestigeBtn" class="prestige">âœ¨ è»¢ç”Ÿã™ã‚‹ï¼ˆæ¡ä»¶: 1.8e308ï¼‰</button>
      <div class="small">â€»è»¢ç”Ÿã™ã‚‹ã¨æ‰€æŒé‡‘ã¨é€šå¸¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã€<b>è»¢ç”Ÿå›æ•° +1 / è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ +1</b> ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚</div>
    </div>
    <hr style="opacity:0.06;margin:10px 0" />
    <div class="row">
      <label>è‡ªå‹•è³¼å…¥ï¼ˆAuto-Buyï¼‰: </label>
      <select id="autoQty" style="padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.03);color:#cfe8da">
        <option value="1">Ã—1</option><option value="10">Ã—10</option><option value="100">Ã—100</option><option value="max">Ã—Max</option>
      </select>
      <label>æœ‰åŠ¹åŒ–ï¼ˆè»¢ç”Ÿå¾Œã«ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼‰ <input id="autoToggle" type="checkbox" /></label>
      <div class="small">è‡ªå‹•è³¼å…¥ã¯è»¢ç”Ÿå›æ•°ãŒ1ä»¥ä¸Šã®ã¨ãã®ã¿å‹•ä½œã—ã¾ã™ã€‚</div>
    </div>
  </div>

  <div id="upgradeContainer"></div>

  <div class="panel">
    <h3 style="margin:6px 0">ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”¨ã®è»¢ç”Ÿï¼ˆæ°¸ç¶šãƒ–ãƒ¼ã‚¹ãƒˆï¼‰</h3>
    <div class="small">è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã€å„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®<strong>æ°¸ç¶šãƒ¬ãƒ™ãƒ«</strong>ã‚’ä¸Šã’ã‚‰ã‚Œã¾ã™ã€‚æ°¸ç¶šãƒ¬ãƒ™ãƒ«ã¯ãã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®æ’ä¹…çš„ãªè£œæ­£ï¼ˆ+2% per levelï¼‰ã‚’ä¸ãˆã¾ã™ã€‚</div>
    <div id="prestigeUpgradeContainer" style="margin-top:8px"></div>
  </div>

<script>
/* ===========================
   ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ10å€‹ï¼‰ â€” æˆé•·æ›²ç·šç·©ã‚„ã‹ã«èª¿æ•´æ¸ˆã¿
   èª¬æ˜:
    - baseRate: åˆæœŸã® "progress %/s ã®ç´ "ï¼ˆå°ã•ã‚ã«ï¼‰
    - speedMult: è³¼å…¥ã§å¢—ãˆã‚‹ rate å€ï¼ˆå¤§ãã™ããªã„ï¼‰
    - baseCost: åˆæœŸã‚³ã‚¹ãƒˆï¼ˆç·©ã‚„ã‹ãªä¸Šæ˜‡ã«ã™ã‚‹ãŸã‚ pow=1.6ï¼‰
   =========================== */
const upgradesTemplate = [
  { name:"åå…¥ã‚¢ãƒƒãƒ—", baseRate:0.9, rate:0.9, mult:0, speedMult:1.22, baseCost:12, level:0, progress:0, prestigeLevel:0 },
  { name:"åŠ¹ç‡ã‚¢ãƒƒãƒ—", baseRate:0.6, rate:0.6, mult:0, speedMult:1.18, baseCost:40, level:0, progress:0, prestigeLevel:0 },
  { name:"è‡ªå‹•è²©å£²æ©Ÿ", baseRate:0.45, rate:0.45, mult:0, speedMult:1.15, baseCost:120, level:0, progress:0, prestigeLevel:0 },
  { name:"éŠ€è¡ŒæŠ•è³‡", baseRate:0.3, rate:0.3, mult:0, speedMult:1.13, baseCost:520, level:0, progress:0, prestigeLevel:0 },
  { name:"AIç”Ÿæˆå·¥å ´", baseRate:0.18, rate:0.18, mult:0, speedMult:1.12, baseCost:2200, level:0, progress:0, prestigeLevel:0 },

  { name:"ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", baseRate:0.14, rate:0.14, mult:0, speedMult:1.10, baseCost:12000, level:0, progress:0, prestigeLevel:0 },
  { name:"ç ”ç©¶æ‰€", baseRate:0.11, rate:0.11, mult:0, speedMult:1.10, baseCost:60000, level:0, progress:0, prestigeLevel:0 },
  { name:"æƒ‘æ˜Ÿé–‹ç™º", baseRate:0.08, rate:0.08, mult:0, speedMult:1.09, baseCost:250000, level:0, progress:0, prestigeLevel:0 },
  { name:"é‡å­ã‚µãƒ¼ãƒãƒ¼", baseRate:0.05, rate:0.05, mult:0, speedMult:1.08, baseCost:1200000, level:0, progress:0, prestigeLevel:0 },
  { name:"æ¬¡å…ƒã‚³ã‚¢", baseRate:0.02, rate:0.02, mult:0, speedMult:1.07, baseCost:6000000, level:0, progress:0, prestigeLevel:0 },
];

function cloneTemplate(){ return JSON.parse(JSON.stringify(upgradesTemplate)); }

/* ===========================
   çŠ¶æ…‹
   =========================== */
let money = 0;
let baseIncome = 1;
let upgrades = cloneTemplate();
let prestigePoints = 0;   // è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆï¼ˆæ¶ˆè²»ã—ã¦å„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®æ°¸ç¶šLvã‚’ä¸Šã’ã‚‹ï¼‰
let prestigeCount = 0;    // è»¢ç”Ÿå›æ•°ï¼ˆAuto-Buy unlock ç”¨ï¼‰
let prestigeMult = 1;     // è»¢ç”Ÿã«ã‚ˆã‚‹ç·åˆå€ç‡ï¼ˆä»»æ„ï¼‰
const COST_POW = 1.6;     // ã‚³ã‚¹ãƒˆä¸Šæ˜‡ã®ç·©ã‚„ã‹ã•ï¼ˆ1.6 -> ç·©ã‚„ã‹ï¼‰

/* ===========================
   DOM ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   =========================== */
const upgradeUI = []; // {root, fillEl, lvlEl, costEl, multEl, rateEl, prestigeLvlEl, btnBuyX...}

/* ===========================
   åŠ©æ‰‹é–¢æ•°
   =========================== */
function formatCompact(n){
  if (typeof n !== 'number') return String(n);
  if (!isFinite(n)) return "Infinity";
  const abs = Math.abs(n);
  if (abs >= 1e15) return n.toExponential(2);
  if (abs >= 1e9) return (n/1e9).toFixed(2) + "B";
  if (abs >= 1e6) return (n/1e6).toFixed(2) + "M";
  return Math.floor(n).toLocaleString();
}
function getUpgradeCost(u){
  // ç·©ã‚„ã‹ãªæˆé•·ï¼š baseCost * (level+1) ^ COST_POW
  return Math.floor(u.baseCost * Math.pow(u.level + 1, COST_POW));
}

/* ===========================
   åˆæœŸ UI ä½œæˆï¼ˆDOMã‚’å†æ§‹ç¯‰ã—ãªã„å·¥å¤«ï¼‰
   =========================== */
function initUI(){
  const container = document.getElementById("upgradeContainer");
  container.innerHTML = "";
  upgrades.forEach((u,i)=>{
    const div = document.createElement("div");
    div.className = "upgrade";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${i+1}. ${u.name}</strong>
        <div class="small">Lv <span id="lvl${i}">0</span></div>
      </div>
      <div class="small" style="margin-top:6px">æ°¸ç¶šLv: <span id="prestLvl${i}">0</span>ï¼ˆ+2% per æ°¸ç¶šLvï¼‰</div>
      <div class="small" style="margin-top:4px">ä¹—æ•°åˆè¨ˆ: <span id="mult${i}">+0.000</span></div>
      <div class="small">ãƒ¡ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦: <span id="rate${i}">${u.rate.toFixed(2)}</span> /s</div>
      <div class="meter"><div id="fill${i}" class="fill" style="width:0%"></div></div>
      <div style="display:flex;gap:6px;justify-content:center;margin-top:6px">
        <button id="buy1_${i}" class="btn-buy">è³¼å…¥ï¼ˆ<span id="cost${i}">0</span>ï¼‰</button>
        <button id="buy10_${i}" class="btn-small">Ã—10</button>
        <button id="buy100_${i}" class="btn-small">Ã—100</button>
        <button id="buyMax_${i}" class="btn-small">Ã—Max</button>
      </div>
    `;
    container.appendChild(div);

    upgradeUI[i] = {
      root: div,
      fillEl: document.getElementById("fill"+i),
      lvlEl: document.getElementById("lvl"+i),
      costEl: document.getElementById("cost"+i),
      multEl: document.getElementById("mult"+i),
      rateEl: document.getElementById("rate"+i),
      prestigeLvlEl: document.getElementById("prestLvl"+i),
      btn1: document.getElementById("buy1_"+i),
      btn10: document.getElementById("buy10_"+i),
      btn100: document.getElementById("buy100_"+i),
      btnMax: document.getElementById("buyMax_"+i),
    };

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    upgradeUI[i].btn1.addEventListener('click', ()=> buyUpgrade(i,1));
    upgradeUI[i].btn10.addEventListener('click', ()=> buyUpgrade(i,10));
    upgradeUI[i].btn100.addEventListener('click', ()=> buyUpgrade(i,100));
    upgradeUI[i].btnMax.addEventListener('click', ()=> buyUpgrade(i, "max"));
  });

  // prestige-upgrade area
  const pcont = document.getElementById("prestigeUpgradeContainer");
  pcont.innerHTML = "";
  upgrades.forEach((u,i)=>{
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "center";
    row.style.marginTop = "6px";
    row.innerHTML = `
      <div class="small">${i+1}. ${u.name} æ°¸ç¶šLv: <span id="pLv${i}">0</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="small">ã‚³ã‚¹ãƒˆ: <span id="pCost${i}">1</span>PP</div>
        <button id="pBuy${i}" class="btn-small">æ°¸ç¶šLv +1</button>
      </div>
    `;
    pcont.appendChild(row);
    document.getElementById("pBuy"+i).addEventListener('click', ()=> buyPrestigeUpgrade(i));
  });
}

/* ===========================
   è¡¨ç¤ºæ›´æ–°ï¼ˆå·®åˆ†æ›´æ–°ã€100msé–“éš”ï¼‰
   =========================== */
let lastUI = 0;
function updateUI(force=false){
  const now = performance.now();
  if (!force && now - lastUI < 100) return;
  lastUI = now;

  document.getElementById("money").textContent = formatCompact(money);
  const totalMult = upgrades.reduce((acc,u)=> acc * (1 + u.mult + (u.prestigeLevel||0)*0.02), 1) * prestigeMult;
  document.getElementById("rate").textContent = (baseIncome * totalMult).toFixed(2);
  document.getElementById("formula").textContent = `åå…¥ = ${baseIncome} Ã— ` +
    upgrades.map(u=>`(1+${(u.mult + (u.prestigeLevel||0)*0.02).toFixed(3)})`).join(" Ã— ") +
    ` Ã— ${prestigeMult.toFixed(2)}`;

  document.getElementById("prestigePoints").textContent = prestigePoints;
  document.getElementById("prestigeCount").textContent = prestigeCount;
  document.getElementById("prestigeMult").textContent = prestigeMult.toFixed(2);

  // å€‹åˆ¥å·®åˆ†
  upgrades.forEach((u,i)=>{
    const ui = upgradeUI[i];
    if (!ui) return;
    ui.lvlEl.textContent = u.level;
    ui.costEl.textContent = formatCompact(getUpgradeCost(u));
    ui.multEl.textContent = `+${u.mult.toFixed(3)}`;
    ui.rateEl.textContent = u.rate.toFixed(2);
    ui.fillEl.style.width = Math.min(u.progress,100) + "%";
    ui.prestigeLvlEl.textContent = u.prestigeLevel || 0;

    // prestige area
    const pcostEl = document.getElementById("pCost"+i);
    if (pcostEl) pcostEl.textContent = (1 + (u.prestigeLevel||0)); // cost = currentPrestigeLevel+1
    const pLvEl = document.getElementById("pLv"+i);
    if (pLvEl) pLvEl.textContent = u.prestigeLevel || 0;
  }

  );

  // Auto-Buy toggle availability: only enabled if prestigeCount >=1
  const autoToggle = document.getElementById("autoToggle");
  if (prestigeCount < 1) {
    autoToggle.checked = false;
    autoToggle.disabled = true;
  } else {
    autoToggle.disabled = false;
  }

  // Prestige button enable
  const prestigeBtn = document.getElementById("prestigeBtn");
  const canPrestige = (!isFinite(money) || money >= 1.8e308);
  prestigeBtn.disabled = !canPrestige;
}

/* ===========================
   è³¼å…¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¤‡æ•°è³¼å…¥å¯¾å¿œï¼‰
   buyUpgrade(i, qty) : qty = 1 | 10 | 100 | "max"
   ã‚³ã‚¹ãƒˆå¼: baseCost * (level+1)^COST_POW
   =========================== */
function buyUpgrade(i, qty){
  const u = upgrades[i];
  if (qty === "max"){
    // ãƒã‚¤ãƒŠãƒªæ¤œç´¢ã§æœ€å¤§å€‹æ•°ã‚’ä¸€æ‹¬è³¼å…¥ï¼ˆåŠ¹ç‡çš„ï¼‰
    let lo = 0, hi = 1;
    // increase hi until cost(hi) > money or hi too big
    while (costToBuy(u,i,hi) <= money && hi < 1e9) hi *= 2;
    // binary search
    while (lo + 1 < hi){
      const mid = Math.floor((lo + hi) / 2);
      if (costToBuy(u,i,mid) <= money) lo = mid;
      else hi = mid;
    }
    if (lo > 0) performBuy(u,i,lo);
    else alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // qty is number
  const q = Number(qty) || 1;
  const c = costToBuy(u,i,q);
  if (c <= money) performBuy(u,i,q);
  else alert("ãã®æ•°ã¯è²·ãˆã¾ã›ã‚“ï¼ˆãŠé‡‘ä¸è¶³ï¼‰ã€‚");
}

// è¨ˆç®—: u ã®ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã‹ã‚‰ n å€‹è²·ã†æ™‚ã®åˆè¨ˆã‚³ã‚¹ãƒˆ
function costToBuy(u, idx, n){
  if (n <= 0) return 0;
  // sum_{k=0}^{n-1} baseCost * (level + 1 + k)^COST_POW
  let total = 0;
  const base = u.baseCost;
  const start = u.level + 1;
  for (let k = 0; k < n; k++){
    total += Math.floor(base * Math.pow(start + k, COST_POW));
    // early cutoff if total gets huge to avoid slow loops
    if (total > 1e308) return Infinity;
  }
  return total;
}

// å®Ÿéš›ã«è³¼å…¥ã—ã¦çŠ¶æ…‹æ›´æ–°
function performBuy(u, idx, n){
  const c = costToBuy(u, idx, n);
  money -= c;
  u.level += n;
  // rate å¢—åŠ ã¯æ§ãˆã‚ã« => speedMult ã® nä¹—
  // approximate multiply rate by speedMult^n but cap growth to avoid explosion
  u.rate *= Math.pow( Math.max(1, u.speedMult), n*0.5 ); // åŠåˆ†ãƒšãƒ¼ã‚¹ã§å¢—ã‚„ã™ï¼ˆç·©ã‚„ã‹ï¼‰
  // update display & save
  updateUI(true);
  saveGame();
}

/* ===========================
   ãƒ¡ãƒ¼ã‚¿ãƒ¼æº€ã‚¿ãƒ³å‡¦ç†ï¼ˆé‡ãŒæºœã¾ã£ãŸã‚‰ä¸€æ‹¬ã§å‡¦ç†ï¼‰
   - ä¹—æ•°å¢—åˆ†ã¯ã‚ˆã‚Šç·©ã‚„ã‹ã«ï¼šåŸºæœ¬ 0.005 Ã— (1 + level)^0.5
   - æ°¸ç¶šLv ã¯ u.prestigeLevel ã«ã‚ˆã‚Šè¿½åŠ ã®å›ºå®š% ã‚’åŠ ãˆã‚‹ (0.02 per level)
   =========================== */
function getMultiplierIncrement(u){
  return 0.005 * Math.pow(1 + u.level, 0.5);
}

/* ===========================
   è»¢ç”Ÿï¼ˆdoPrestigeï¼‰
   - è»¢ç”Ÿã§: prestigeCount++, prestigePoints++ã€prestigeMult increment optional
   - ãƒªã‚»ãƒƒãƒˆ: money=0, upgrades reset (but their æ°¸ç¶šLv ã¯æ®‹ã‚‹)
   =========================== */
function doPrestige(force=false){
  if (!force){
    if (!(money >= 1.8e308 || !isFinite(money))){
      alert("è»¢ç”Ÿæ¡ä»¶ã«é”ã—ã¦ã„ã¾ã›ã‚“ï¼ˆé€šå¸¸ã¯ 1.8e308ï¼‰ã€‚");
      return;
    }
    if (!confirm("æœ¬å½“ã«è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ æ‰€æŒé‡‘ã¨é€šå¸¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼ˆæ°¸ç¶šLvã¯ä¿æŒï¼‰ã€‚")) return;
  }
  prestigeCount += 1;
  prestigePoints += 1;
  prestigeMult += 0.2; // è»¢ç”Ÿã”ã¨ã«ã‚ãšã‹ã«æ°¸ç¶šå€ç‡å¢—ï¼ˆä»»æ„ï¼‰
  money = 0;
  // reset upgrades to template but KEEP prestigeLevel for each
  const oldPrest = upgrades.map(u=>u.prestigeLevel || 0);
  upgrades = cloneTemplate();
  upgrades.forEach((u,i)=> u.prestigeLevel = oldPrest[i] || 0);
  initUI();
  updateUI(true);
  saveGame();
  alert("è»¢ç”Ÿå®Œäº†ï¼ è»¢ç”Ÿå›æ•° +1 / è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ +1");
}

/* ===========================
   å„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã”ã¨ã®è»¢ç”Ÿï¼ˆæ°¸ç¶šLvè³¼å…¥ï¼‰
   - ã‚³ã‚¹ãƒˆ: current prestigeLevel + 1 (1PP, then 2PP, etc.)
   - åŠ¹æœ: æ°¸ç¶šLv 1 ã‚ãŸã‚Š +2%ï¼ˆ=0.02ï¼‰ ã‚’åå…¥è¨ˆç®—ã«è¿½åŠ 
   =========================== */
function buyPrestigeUpgrade(i){
  const u = upgrades[i];
  const cost = (u.prestigeLevel || 0) + 1;
  if (prestigePoints >= cost){
    prestigePoints -= cost;
    u.prestigeLevel = (u.prestigeLevel || 0) + 1;
    updateUI(true);
    saveGame();
  } else {
    alert("è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
  }
}

/* ===========================
   Auto-Buy å®Ÿè£…
   - æœ‰åŠ¹ã‹ã¤ prestigeCount>=1 ã®æ™‚ã«å‹•ã
   - å®šæœŸï¼ˆintervalAutoBuy msï¼‰ã§è‡ªå‹•è³¼è²·ã‚’è©¦ã¿ã‚‹
   =========================== */
const intervalAutoBuy = 1000; // 1s
setInterval(()=> {
  const autoEnabled = document.getElementById("autoToggle").checked && prestigeCount >= 1;
  if (!autoEnabled) return;
  const qtySel = document.getElementById("autoQty").value;
  upgrades.forEach((u,i) => {
    // try to buy for each upgrade in order (can be changed to strategy)
    if (qtySel === "max") buyUpgrade(i,"max");
    else buyUpgrade(i, Number(qtySel));
  });
}, intervalAutoBuy);

/* ===========================
   ã‚»ãƒ¼ãƒ– / ãƒ­ãƒ¼ãƒ‰ï¼ˆæ°¸ç¶šLv ãªã©å«ã‚€ï¼‰
   =========================== */
function saveGame(){
  try {
    const save = { money, baseIncome, upgrades, prestigePoints, prestigeCount, prestigeMult };
    localStorage.setItem("idleSave_v11", JSON.stringify(save));
  } catch(e){ console.warn("save failed", e); }
}
function loadGame(){
  try {
    const raw = localStorage.getItem("idleSave_v11");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (typeof data.money === 'number') money = data.money;
    if (typeof data.baseIncome === 'number') baseIncome = data.baseIncome;
    if (Array.isArray(data.upgrades) && data.upgrades.length === upgradesTemplate.length) upgrades = data.upgrades;
    if (typeof data.prestigePoints === 'number') prestigePoints = data.prestigePoints;
    if (typeof data.prestigeCount === 'number') prestigeCount = data.prestigeCount;
    if (typeof data.prestigeMult === 'number') prestigeMult = data.prestigeMult;
  } catch(e){ console.warn("load failed", e); }
}

/* ===========================
   ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€é©åŒ–æ¸ˆã¿ï¼‰
   =========================== */
initUI();
loadGame();
updateUI(true);

let last = Date.now();
function loop(){
  const now = Date.now();
  let delta = (now - last) / 1000;
  last = now;
  if (!isFinite(delta) || delta <= 0) delta = 0;
  const MAX_DELTA = 1.0;
  if (delta > MAX_DELTA) delta = MAX_DELTA;

  // å„ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ï¼ˆprogressã¯0..100ï¼‰
  upgrades.forEach(u => {
    u.progress += u.rate * delta * 100;
    if (u.progress >= 100){
      // completedã‚’ä¸€æ‹¬è¨ˆç®—ï¼ˆåŠ¹ç‡çš„ï¼‰
      let completed = Math.floor(u.progress / 100);
      const MAX_COMPLETED = 1e6;
      if (completed > MAX_COMPLETED) completed = MAX_COMPLETED;
      u.progress -= completed * 100;
      // ä¹—æ•°å¢—åˆ†ï¼ˆç·©ã‚„ã‹ï¼‰
      const inc = getMultiplierIncrement(u);
      // æ°¸ç¶šLvï¼ˆprestigeLevelï¼‰ ãŒã‚ã‚‹ã¨æ›´ã«å½±éŸ¿ï¼ˆã“ã“ã¯å®šç¾©æ¸ˆï¼‰
      u.mult += inc * completed;
    }
  });

  // åå…¥åŠ ç®—ï¼šå„ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã«æ°¸ç¶šãƒœãƒ¼ãƒŠã‚¹ (0.02 per prestigeLevel) ã‚’å«ã‚ã‚‹
  const totalMult = upgrades.reduce((acc,u)=> acc * (1 + u.mult + (u.prestigeLevel||0) * 0.02), 1) * prestigeMult;
  money += baseIncome * totalMult * delta;

  // UIæ›´æ–° throttle
  updateUI();

  // ã‚»ãƒ¼ãƒ– 5ç§’ã”ã¨ï¼ˆroughï¼‰
  if (Date.now() % 5000 < 50) saveGame();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===========================
   URL ãƒ‡ãƒãƒƒã‚° æ”¯æ´
   - ?forcePrestige=1 ã§å¼·åˆ¶è»¢ç”Ÿï¼ˆãƒ†ã‚¹ãƒˆï¼‰
   - ?money=1.8e308 ã§åˆæœŸè³‡é‡‘ã‚»ãƒƒãƒˆ
   =========================== */
const params = new URLSearchParams(location.search);
if (params.get("money")){
  const m = Number(params.get("money"));
  money = isFinite(m) ? m : Number(params.get("money"));
  updateUI(true);
}
if (params.get("forcePrestige")==="1" || params.get("forcePrestige")==="true"){
  setTimeout(()=> doPrestige(true), 200);
}

/* ===========================
   ãƒœã‚¿ãƒ³æ¥ç¶š
   =========================== */
document.getElementById("prestigeBtn").addEventListener('click', ()=> doPrestige(false));
window.addEventListener('beforeunload', ()=> saveGame());
</script>
</body>
</html>
