<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ ï¼ˆè»¢ç”Ÿå¾©æ´»ç‰ˆï¼‰</title>
<style>
  body { font-family:"Segoe UI",sans-serif; background:#111; color:#fff; text-align:center; margin:0; padding:20px; }
  h1 { color:#00e676; text-shadow:0 0 8px #00e676; }
  .stats { margin:20px auto; padding:10px 20px; background:rgba(255,255,255,0.05); border-radius:12px; width:420px; }
  .money { font-size:1.8em; color:#00e676; font-weight:bold; }
  .formula { font-size:0.9em; color:#ccc; margin-top:5px; }
  .upgrade { background:rgba(255,255,255,0.07); border-radius:10px; padding:12px; margin:10px auto; width:90%; max-width:520px; box-shadow:0 0 6px rgba(0,0,0,0.4); }
  .meter { background:rgba(255,255,255,0.1); border-radius:10px; height:18px; overflow:hidden; margin:8px 0; }
  .fill { height:100%; background:linear-gradient(90deg,#00e676,#00bfa5); width:0%; transition:width 0.12s linear; }
  button { background:linear-gradient(90deg,#00e676,#00bfa5); border:none; border-radius:6px; color:black; font-weight:bold; padding:6px 12px; cursor:pointer; }
  .prestige { margin-top:14px; background:linear-gradient(90deg,#ffca28,#f57f17); border:none; border-radius:10px; padding:10px 18px; color:#000; font-weight:bold; cursor:pointer; }
  .prestige:disabled { opacity:0.5; cursor:not-allowed; }
  .small { font-size:0.9em; color:#ccc; }
</style>
</head>
<body>
  <h1>ğŸ’° æ”¾ç½®ãƒãƒãƒ¼ã‚²ãƒ¼ãƒ ï¼ˆè»¢ç”Ÿå¾©æ´»ç‰ˆï¼‰</h1>

  <div class="stats">
    <div>æ‰€æŒé‡‘ï¼š<span class="money" id="money">0</span></div>
    <div>1ç§’ã‚ãŸã‚Šã®åå…¥ï¼š<span id="rate">0</span></div>
    <div class="formula" id="formula">(è¨ˆç®—å¼)</div>
    <div class="small">è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆï¼š<span id="prestigePoints">0</span></div>
    <div class="small">è»¢ç”Ÿå€ç‡ï¼ˆæ°¸ç¶šï¼‰ï¼šÃ—<span id="prestigeMult">1</span></div>
  </div>

  <div id="upgradeContainer"></div>

  <div style="margin-top:12px;">
    <button id="prestigeBtn" class="prestige" onclick="doPrestige()">âœ¨ è»¢ç”Ÿã™ã‚‹ï¼ˆæ¡ä»¶: 1.8e308ï¼‰</button>
  </div>

  <div style="margin-top:10px;" class="small">
    ï¼ˆæ³¨ï¼‰ãƒ‡ãƒãƒƒã‚°ã§å³è»¢ç”Ÿã•ã›ãŸã„å ´åˆã¯ URL ã« <code>?forcePrestige=1</code> ã‚’ä»˜ã‘ã‚‹ã‹ã€
    ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ <code>doPrestige(true)</code> ã‚’å‘¼ã‚“ã§ãã ã•ã„ã€‚
  </div>

<script>
// -------------------- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾© --------------------
const upgradesTemplate = [
  { name:"åå…¥ã‚¢ãƒƒãƒ—", baseRate:1.0, rate:1.0, mult:0, speedMult:1.5, baseCost:10, level:0, progress:0 },
  { name:"åŠ¹ç‡ã‚¢ãƒƒãƒ—", baseRate:0.8, rate:0.8, mult:0, speedMult:1.4, baseCost:30, level:0, progress:0 },
  { name:"è‡ªå‹•è²©å£²æ©Ÿ", baseRate:0.6, rate:0.6, mult:0, speedMult:1.3, baseCost:100, level:0, progress:0 },
  { name:"éŠ€è¡ŒæŠ•è³‡", baseRate:0.4, rate:0.4, mult:0, speedMult:1.25, baseCost:500, level:0, progress:0 },
  { name:"AIç”Ÿæˆå·¥å ´", baseRate:0.2, rate:0.2, mult:0, speedMult:1.2, baseCost:2000, level:0, progress:0 },
];

// deep copy helper
function cloneTemplate() { return JSON.parse(JSON.stringify(upgradesTemplate)); }

// -------------------- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ --------------------
let money = 0;
let baseIncome = 1;
let upgrades = cloneTemplate();
let prestigePoints = 0;
let prestigeMultiplier = 1;

// -------------------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --------------------
function formatNum(n){
  if (typeof n !== 'number') return String(n);
  if (!isFinite(n)) return "Infinity";
  if (Math.abs(n) >= 1e9) return n.toExponential(2);
  return Math.floor(n).toLocaleString();
}
function getUpgradeCost(u){ return Math.floor(u.baseCost * Math.pow(2.2, u.level)); }

// -------------------- è¡¨ç¤º --------------------
function updateDisplay(){
  document.getElementById("money").textContent = formatNum(money);
  const totalMult = upgrades.reduce((acc,u) => acc * (1 + u.mult), 1) * prestigeMultiplier;
  document.getElementById("rate").textContent = (baseIncome * totalMult).toFixed(2);
  document.getElementById("formula").textContent =
    `åå…¥ = ${baseIncome} Ã— ` + upgrades.map(u=>`(1+${u.mult.toFixed(3)})`).join(" Ã— ") + ` Ã— ${prestigeMultiplier.toFixed(2)}`;
  document.getElementById("prestigePoints").textContent = prestigePoints;
  document.getElementById("prestigeMult").textContent = prestigeMultiplier.toFixed(2);

  // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æç”»
  const container = document.getElementById("upgradeContainer");
  container.innerHTML = "";
  upgrades.forEach((u,i)=>{
    const div = document.createElement("div");
    div.className = "upgrade";
    const cost = getUpgradeCost(u);
    div.innerHTML = `
      <h3>${u.name} (Lv ${u.level})</h3>
      <div class="small">ä¹—æ•°åˆè¨ˆ: +${u.mult.toFixed(3)}</div>
      <div class="small">ãƒ¡ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦: ${u.rate.toFixed(2)} /s</div>
      <div class="meter"><div id="fill${i}" class="fill" style="width:${Math.min(u.progress,100)}%"></div></div>
      <button onclick="buyUpgrade(${i})">è³¼å…¥ï¼ˆ${cost.toLocaleString()}ï¼‰</button>
    `;
    container.appendChild(div);
  });

  // è»¢ç”Ÿãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–åˆ¤å®šï¼ˆ1.8e308 ã¾ãŸã¯ Infinity ã‚’è¨±å®¹ï¼‰
  const prestigeBtn = document.getElementById("prestigeBtn");
  const canPrestige = (!isFinite(money) || money >= 1.8e308);
  prestigeBtn.disabled = !canPrestige;
}

// -------------------- è³¼å…¥ --------------------
function buyUpgrade(i){
  const u = upgrades[i];
  const cost = getUpgradeCost(u);
  if (money >= cost){
    money -= cost;
    u.level++;
    u.rate *= u.speedMult; // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ãƒ¡ãƒ¼ã‚¿ãƒ¼å……å¡«é€Ÿåº¦ã‚’ä¸ŠãŒã‚‹
    saveGame();
    updateDisplay();
  } else {
    alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
  }
}

// -------------------- ä¹—æ•°å¢—åˆ†ãƒ«ãƒ¼ãƒ« --------------------
function getMultiplierIncrement(u){
  // è¦æœ›ã©ãŠã‚Šï¼šåŸºæœ¬0.01ã«ãƒ¬ãƒ™ãƒ«ä¾å­˜ï¼ˆlevel0->0.01, level1->0.02...ï¼‰
  return 0.01 * (1 + u.level);
}

// -------------------- è»¢ç”Ÿ --------------------
function doPrestige(force=false){
  if (!force) {
    // é€šå¸¸æ™‚ã¯æ¡ä»¶ãƒã‚§ãƒƒã‚¯ã€‚JSã®è¡¨ç¾ä¸Šã€1.8e308 ã¯ Infinity ã«ãªã‚Šã†ã‚‹ãŸã‚ä¸¡æ–¹ãƒã‚§ãƒƒã‚¯ã€‚
    if (!(money >= 1.8e308 || !isFinite(money))) {
      alert("è»¢ç”Ÿæ¡ä»¶ã«é”ã—ã¦ã„ã¾ã›ã‚“ï¼ˆé€šå¸¸ã¯ 1.8e308 ï¼‰ã€‚");
      return;
    }
    if (!confirm("æœ¬å½“ã«è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ æ‰€æŒé‡‘ã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚")) return;
  }
  // è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ +1ï¼ˆè¦æœ›ï¼‰
  prestigePoints += 1;
  // ã“ã“ã§ã¯è»¢ç”Ÿå€ç‡ã‚’æ°¸ç¶šçš„ã«+"1"ã™ã‚‹ï¼ˆå¸Œæœ›ãŒã‚ã‚Œã°å¤‰æ›´å¯ï¼‰
  prestigeMultiplier += 1;

  // ãƒªã‚»ãƒƒãƒˆï¼šåˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã™
  money = 0;
  upgrades = cloneTemplate();
  saveGame();
  updateDisplay();

  alert("è»¢ç”Ÿå®Œäº†ï¼ è»¢ç”Ÿãƒã‚¤ãƒ³ãƒˆ +1 / è»¢ç”Ÿå€ç‡ +1");
}

// -------------------- ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰ --------------------
function saveGame(){
  try {
    const save = { money, baseIncome, upgrades, prestigePoints, prestigeMultiplier };
    localStorage.setItem("idleMultiMeterSave", JSON.stringify(save));
  } catch(e){ console.warn("save failed", e); }
}

function loadGame(){
  try {
    const raw = localStorage.getItem("idleMultiMeterSave");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (typeof data.money === 'number') money = data.money;
    if (typeof data.baseIncome === 'number') baseIncome = data.baseIncome;
    if (Array.isArray(data.upgrades) && data.upgrades.length === upgradesTemplate.length) upgrades = data.upgrades;
    if (typeof data.prestigePoints === 'number') prestigePoints = data.prestigePoints;
    if (typeof data.prestigeMultiplier === 'number') prestigeMultiplier = data.prestigeMultiplier;
  } catch(e){ console.warn("load failed", e); }
}

// -------------------- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— --------------------
loadGame();
let last = Date.now();
function loop(){
  const now = Date.now();
  const delta = (now - last) / 1000;
  last = now;

  // å„ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ï¼ˆu.rate ã¯ "progress % per second" ã®ç´ ï¼‰
  upgrades.forEach(u=>{
    // ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯ 0..100 (percent)
    u.progress += u.rate * delta * 100;
    // 100%ä»¥ä¸Šæºœã¾ã£ãŸã‚‰è¤‡æ•°å›å‡¦ç†
    while (u.progress >= 100){
      u.progress -= 100;
      const inc = getMultiplierIncrement(u);
      u.mult += inc;
    }
  });

  // åå…¥åŠ ç®—ï¼ˆæ›ã‘ç®—ã« prestigeMultiplier ã‚’ã‹ã‘ã‚‹ï¼‰
  const totalMult = upgrades.reduce((acc,u) => acc * (1 + u.mult), 1) * prestigeMultiplier;
  money += baseIncome * totalMult * delta;

  // UI ãƒ¡ãƒ¼ã‚¿ãƒ¼æç”»ï¼ˆé«˜é€Ÿæ›´æ–°ï¼‰
  upgrades.forEach((u,i)=>{
    const el = document.getElementById("fill"+i);
    if (el) el.style.width = Math.min(u.progress,100) + "%";
  });

  updateDisplay();
  // 5ç§’ãŠãã«è‡ªå‹•ä¿å­˜ï¼ˆè»½è² è·ï¼‰
  if (now % 5000 < 50) saveGame();
  requestAnimationFrame(loop);
}
updateDisplay();
loop();

// -------------------- ãƒ‡ãƒãƒƒã‚°URLã‚µãƒãƒ¼ãƒˆ --------------------
const params = new URLSearchParams(location.search);
if (params.get("forcePrestige") === "1" || params.get("forcePrestige") === "true") {
  // UIåˆæœŸåŒ–å¾Œã«å¼·åˆ¶å®Ÿè¡Œ
  setTimeout(()=> doPrestige(true), 200);
}
</script>
</body>
</html>
