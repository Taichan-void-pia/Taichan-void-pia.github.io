<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Fix: æ”¾ç½®ã‚²ãƒ¼ãƒ  (å‹•ä½œç¢ºèªç‰ˆ)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family: system-ui, "Segoe UI", Roboto, Helvetica, Arial; background:#071018;color:#fff;margin:0;padding:16px}
  h1{color:#7bf3a8;margin:0 0 8px 0}
  .errorBanner{background:#5b1010;color:#fff;padding:8px;border-radius:6px;margin-bottom:10px;display:none}
  .stats{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:10px}
  #money{font-weight:700;color:#7bf3a8}
  #upgradeContainer{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
  .upgrade{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .meter{height:14px;background:rgba(255,255,255,0.04);border-radius:7px;overflow:hidden;margin:6px 0}
  .fill{height:100%;background:linear-gradient(90deg,#7bf3a8,#39d092);width:0%}
  .btn{padding:6px;border-radius:6px;border:0;cursor:pointer}
  .btn-primary{background:#7bf3a8;color:#003628}
  .btn-small{background:rgba(255,255,255,0.03);color:#cfe8da;padding:4px 6px}
  .panel{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px}
  .small{font-size:0.85em;color:#cfe8da}
</style>
</head>
<body>
  <div id="error" class="errorBanner"></div>

  <h1>ğŸ’° æ”¾ç½®ã‚²ãƒ¼ãƒ ï¼ˆå‹•ä½œç¢ºèªç‰ˆï¼‰</h1>

  <div class="stats">
    æ‰€æŒé‡‘ï¼š<span id="money">0</span>ã€€
    ç§’ã‚ãŸã‚Šï¼š<span id="rate">0</span>
    <div class="small" id="formula">(è¨ˆç®—å¼)</div>
  </div>

  <div class="panel">
    <button id="globalPrestigeBtn" class="btn btn-primary">âœ¨ ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿ</button>
    <label class="small" style="margin-left:8px">Auto-buy:
      <select id="autoQty">
        <option value="1">Ã—1</option>
        <option value="10">Ã—10</option>
        <option value="100">Ã—100</option>
        <option value="max">Ã—Max</option>
      </select>
      <input id="autoToggle" type="checkbox" style="margin-left:6px" />ï¼ˆè»¢ç”Ÿ1å›å¾Œã«æœ‰åŠ¹ï¼‰
    </label>
    <div class="small" style="margin-top:6px">ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿåˆå›æ¡ä»¶: 1e20ï¼ˆ2å›ç›®ä»¥é™ã¯å‰å›è»¢ç”Ÿã‚¹ã‚³ã‚¢ä»¥ä¸Šï¼‰</div>
  </div>

  <div id="upgradeContainer"></div>

  <div id="prestigeUpgradeContainer" class="panel small"></div>

<script>
(function(){
  // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼
  function showError(msg){
    const el = document.getElementById('error');
    el.style.display = 'block';
    el.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + msg;
    console.error(msg);
  }

  try {
    // ---------- å®šç¾© ----------
    const upgradesTemplate = [
      { name:"åå…¥ã‚¢ãƒƒãƒ—", baseRate:0.9, rate:0.9, mult:0, speedMult:1.18, baseCost:12, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"åŠ¹ç‡ã‚¢ãƒƒãƒ—", baseRate:0.6, rate:0.6, mult:0, speedMult:1.16, baseCost:40, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"è‡ªå‹•è²©å£²æ©Ÿ", baseRate:0.45, rate:0.45, mult:0, speedMult:1.14, baseCost:120, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"éŠ€è¡ŒæŠ•è³‡", baseRate:0.3, rate:0.3, mult:0, speedMult:1.12, baseCost:520, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"AIç”Ÿæˆå·¥å ´", baseRate:0.18, rate:0.18, mult:0, speedMult:1.10, baseCost:2200, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", baseRate:0.14, rate:0.14, mult:0, speedMult:1.09, baseCost:12000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"ç ”ç©¶æ‰€", baseRate:0.11, rate:0.11, mult:0, speedMult:1.085, baseCost:60000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"æƒ‘æ˜Ÿé–‹ç™º", baseRate:0.08, rate:0.08, mult:0, speedMult:1.07, baseCost:250000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"é‡å­ã‚µãƒ¼ãƒãƒ¼", baseRate:0.05, rate:0.05, mult:0, speedMult:1.055, baseCost:1200000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
      { name:"æ¬¡å…ƒã‚³ã‚¢", baseRate:0.02, rate:0.02, mult:0, speedMult:1.04, baseCost:6000000, level:0, progress:0, prestigeLevel:{mult:0,rate:0,cost:0}, ascendCount:0 },
    ];

    function cloneTemplate(){ return JSON.parse(JSON.stringify(upgradesTemplate)); }

    // ---------- state ----------
    let money = 0;
    let baseIncome = 1;
    let upgrades = cloneTemplate();
    let prestigePoints = 0;
    let prestigeCount = 0;
    let prestigeMult = 1;
    let lastGlobalPrestigeScore = 0;
    const COST_POW = 1.5;

    // ---------- DOM cache ----------
    const upgradeUI = [];

    // ---------- helpers ----------
    function fmt(n){
      if (typeof n !== 'number') return String(n);
      if (!isFinite(n)) return "Infinity";
      const a = Math.abs(n);
      if (a >= 1e15) return n.toExponential(2);
      if (a >= 1e9) return (n/1e9).toFixed(2) + "B";
      if (a >= 1e6) return (n/1e6).toFixed(2) + "M";
      return Math.floor(n).toLocaleString();
    }
    function getUpgradeCost(u){
      const raw = Math.floor(u.baseCost * Math.pow(u.level + 1, COST_POW));
      const reduction = 1 - 0.03 * ((u.prestigeLevel && u.prestigeLevel.cost) || 0);
      const v = Math.max(1, Math.floor(raw * Math.max(reduction, 0.5)));
      return v;
    }

    // ---------- UI init ----------
    function initUI(){
      const container = document.getElementById('upgradeContainer');
      container.innerHTML = '';
      upgrades.forEach((u,i) => {
        const div = document.createElement('div');
        div.className = 'upgrade';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between"><strong>${i+1}. ${u.name}</strong><div class="small">Lv <span id="lvl${i}">0</span></div></div>
          <div class="small">æ˜‡å¤©å›æ•°: <span id="asc${i}">0</span></div>
          <div class="small">æ°¸ç¶š Lv(m/r/c): <span id="pLv${i}">0</span>/<span id="pLvR${i}">0</span>/<span id="pLvC${i}">0</span></div>
          <div class="small">ä¹—æ•°åˆè¨ˆ: <span id="mult${i}">+0.000</span></div>
          <div class="small">ãƒ¡ãƒ¼ã‚¿ãƒ¼é€Ÿåº¦: <span id="rate${i}">${u.rate.toFixed(2)}</span>/s</div>
          <div class="meter"><div id="fill${i}" class="fill" style="width:0%"></div></div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
            <button id="buy1_${i}" class="btn btn-primary">è³¼å…¥ï¼ˆ<span id="cost${i}">0</span>ï¼‰</button>
            <button id="buy10_${i}" class="btn btn-small">Ã—10</button>
            <button id="buy100_${i}" class="btn btn-small">Ã—100</button>
            <button id="buyMax_${i}" class="btn btn-small">Ã—Max</button>
            <button id="asc_${i}" class="btn btn-small">æ˜‡å¤©</button>
          </div>
        `;
        container.appendChild(div);
        upgradeUI[i] = {
          fillEl: document.getElementById('fill'+i),
          lvlEl: document.getElementById('lvl'+i),
          costEl: document.getElementById('cost'+i),
          multEl: document.getElementById('mult'+i),
          rateEl: document.getElementById('rate'+i),
          ascEl: document.getElementById('asc'+i),
          pLvEl: document.getElementById('pLv'+i),
          pLvREl: document.getElementById('pLvR'+i),
          pLvCEl: document.getElementById('pLvC'+i),
          btn1: document.getElementById('buy1_'+i),
          btn10: document.getElementById('buy10_'+i),
          btn100: document.getElementById('buy100_'+i),
          btnMax: document.getElementById('buyMax_'+i),
          btnAsc: document.getElementById('asc_'+i),
        };
        // events
        upgradeUI[i].btn1.addEventListener('click', ()=> buyUpgrade(i,1));
        upgradeUI[i].btn10.addEventListener('click', ()=> buyUpgrade(i,10));
        upgradeUI[i].btn100.addEventListener('click', ()=> buyUpgrade(i,100));
        upgradeUI[i].btnMax.addEventListener('click', ()=> buyUpgrade(i,'max'));
        upgradeUI[i].btnAsc.addEventListener('click', ()=> tryAscend(i));
      });

      // prestige UI minimal
      const pcont = document.getElementById('prestigeUpgradeContainer');
      pcont.innerHTML = '<div class="small">æ°¸ç¶š(Prestige)ã¯å„ã‚«ãƒ¼ãƒ‰ã®ã€Œæ°¸ç¶šLvã€ã§è³¼å…¥ã—ã¾ã™ï¼ˆå¾Œã§æ‹¡å¼µï¼‰ã€‚</div>';
    }

    // ---------- UI update (throttled) ----------
    let lastUI = 0;
    function updateUI(force){
      const now = performance.now();
      if (!force && now - lastUI < 100) return;
      lastUI = now;
      // money and rate
      document.getElementById('money').textContent = fmt(money);
      const totalMult = upgrades.reduce((acc,u)=>{
        const pMult = ((u.prestigeLevel && u.prestigeLevel.mult) || 0) * 0.02;
        const asc = (u.ascendCount || 0) * 0.05;
        return acc * (1 + u.mult + pMult + asc);
      },1) * prestigeMult;
      document.getElementById('rate').textContent = (baseIncome * totalMult).toFixed(2);
      document.getElementById('formula').textContent = 'åå…¥ = ' + baseIncome + ' Ã— ' +
        upgrades.map(u=>'(1+' + (u.mult + ((u.prestigeLevel && u.prestigeLevel.mult)||0)*0.02 + ((u.ascendCount||0)*0.05)).toFixed(3)+')').join(' Ã— ');
      // per-upgrade updates
      upgrades.forEach((u,i)=>{
        const ui = upgradeUI[i];
        if (!ui) return;
        ui.lvlEl.textContent = u.level;
        ui.costEl.textContent = fmt(getUpgradeCost(u));
        ui.multEl.textContent = '+' + u.mult.toFixed(3);
        ui.rateEl.textContent = u.rate.toFixed(2);
        ui.fillEl.style.width = Math.min(u.progress,100) + '%';
        ui.ascEl.textContent = u.ascendCount || 0;
        ui.pLvEl.textContent = (u.prestigeLevel && u.prestigeLevel.mult) || 0;
        ui.pLvREl.textContent = (u.prestigeLevel && u.prestigeLevel.rate) || 0;
        ui.pLvCEl.textContent = (u.prestigeLevel && u.prestigeLevel.cost) || 0;
        ui.btnAsc.disabled = !(u.level >= (100 * ((u.ascendCount || 0) + 1)));
      });
      // global prestige enable
      const gbtn = document.getElementById('globalPrestigeBtn');
      const can = (money >= 1e20 && (prestigeCount === 0 || money >= lastGlobalPrestigeScore));
      gbtn.disabled = !can;
      // auto toggle lock when no global prestige yet
      const autoToggle = document.getElementById('autoToggle');
      if (prestigeCount < 1) { autoToggle.checked = false; autoToggle.disabled = true; }
      else autoToggle.disabled = false;
    }

    // ---------- buying ----------
    function costToBuy(u,n){
      if (n <= 0) return 0;
      const base = u.baseCost;
      const start = u.level + 1;
      let total = 0;
      for (let k=0;k<n;k++){
        const raw = Math.floor(base * Math.pow(start + k, COST_POW));
        const reduction = 1 - 0.03 * ((u.prestigeLevel && u.prestigeLevel.cost) || 0);
        total += Math.max(1, Math.floor(raw * Math.max(reduction,0.5)));
        if (total > 1e308) return Infinity;
      }
      return total;
    }
    function buyUpgrade(idx, qty){
      const u = upgrades[idx];
      if (qty === 'max'){
        // binary search
        let lo = 0, hi = 1;
        while (costToBuy(u,hi) <= money && hi < 1e9) hi *= 2;
        while (lo + 1 < hi){
          const mid = Math.floor((lo + hi)/2);
          if (costToBuy(u, mid) <= money) lo = mid;
          else hi = mid;
        }
        if (lo > 0) doPurchase(u, idx, lo);
        else alert('ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');
        return;
      }
      const n = Number(qty) || 1;
      const c = costToBuy(u, n);
      if (c <= money) doPurchase(u, idx, n);
      else alert('ãã®æ•°ã¯è²·ãˆã¾ã›ã‚“ï¼ˆãŠé‡‘ä¸è¶³ï¼‰');
    }
    function doPurchase(u, idx, n){
      const c = costToBuy(u, n);
      money -= c;
      u.level += n;
      u.rate *= Math.pow(Math.max(1, u.speedMult), n * 0.4);
      saveGame();
      updateUI(true);
    }

    // ---------- progress handling ----------
    function getMultiplierIncrement(u){
      return 0.004 * Math.pow(1 + u.level, 0.45);
    }

    function tryAscend(i){
      const u = upgrades[i];
      const need = 100 * ((u.ascendCount || 0) + 1);
      if (u.level < need){ alert('å¿…è¦LvãŒè¶³ã‚Šã¾ã›ã‚“: ' + need); return; }
      if (!confirm(u.name + ' ã‚’æ˜‡å¤©ã—ã¾ã™ã‹ï¼Ÿ Lv ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼ˆæ°¸ä¹…ãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸ï¼‰ã€‚')) return;
      u.ascendCount = (u.ascendCount || 0) + 1;
      u.level = 0;
      u.progress = 0;
      saveGame();
      updateUI(true);
      alert(u.name + ' ã‚’æ˜‡å¤©ã—ã¾ã—ãŸï¼ˆæ˜‡å¤©å›æ•°: ' + u.ascendCount + 'ï¼‰');
    }

    // ---------- prestige global ----------
    function doGlobalPrestige(force){
      if (!force){
        if (!(money >= 1e20)) { alert('ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿæ¡ä»¶: ã‚¹ã‚³ã‚¢ >= 1e20'); return; }
        if (prestigeCount > 0 && money < lastGlobalPrestigeScore){ alert('å‰å›è»¢ç”Ÿæ™‚ã‚¹ã‚³ã‚¢ä»¥ä¸Šã§ãªã„ã¨å†è»¢ç”Ÿã§ãã¾ã›ã‚“'); return; }
        if (!confirm('ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
      }
      const score = money;
      let extra = 1;
      if (score >= 1e20){
        extra = 1 + Math.log10(score / 1e20);
        if (!isFinite(extra) || extra < 1) extra = 1;
      }
      prestigePoints += 1;
      prestigeCount += 1;
      prestigeMult *= extra;
      lastGlobalPrestigeScore = score;
      money = 0;
      // reset level/progress but keep prestigeLevel and ascendCount
      upgrades.forEach(u => { u.level = 0; u.progress = 0; });
      initUI();
      saveGame();
      updateUI(true);
      alert('ã‚°ãƒ­ãƒ¼ãƒãƒ«è»¢ç”Ÿå®Œäº†: prestigePoints +1, åå…¥å€ç‡ Ã—' + extra.toFixed(2));
    }

    // ---------- auto-buy ----------
    setInterval(function(){
      try {
        const autoOn = document.getElementById('autoToggle').checked && prestigeCount >= 1;
        if (!autoOn) return;
        const qty = document.getElementById('autoQty').value;
        // cheapest upgrade strategy
        const order = upgrades.map((u,i)=>({i,c:getUpgradeCost(u)})).sort((a,b)=>a.c - b.c);
        for (let k=0;k<order.length;k++){
          const entry = order[k];
          if (getUpgradeCost(upgrades[entry.i]) <= money){
            buyUpgrade(entry.i, qty);
            break;
          }
        }
      } catch(e){
        console.warn('auto-buy error', e);
      }
    }, 900);

    // ---------- save/load ----------
    function saveGame(){
      try {
        const save = { money, baseIncome, upgrades, prestigePoints, prestigeCount, prestigeMult, lastGlobalPrestigeScore };
        localStorage.setItem('idle_fix_save', JSON.stringify(save));
      } catch(e){ console.warn('save fail', e); }
    }
    function loadGame(){
      try {
        const raw = localStorage.getItem('idle_fix_save');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (typeof data.money === 'number') money = data.money;
        if (typeof data.baseIncome === 'number') baseIncome = data.baseIncome;
        if (Array.isArray(data.upgrades) && data.upgrades.length === upgradesTemplate.length) upgrades = data.upgrades;
        if (typeof data.prestigePoints === 'number') prestigePoints = data.prestigePoints;
        if (typeof data.prestigeCount === 'number') prestigeCount = data.prestigeCount;
        if (typeof data.prestigeMult === 'number') prestigeMult = data.prestigeMult;
        if (typeof data.lastGlobalPrestigeScore === 'number') lastGlobalPrestigeScore = data.lastGlobalPrestigeScore;
      } catch(e){ console.warn('load fail', e); }
    }

    // ---------- main loop ----------
    initUI();
    loadGame();
    updateUI(true);

    let last = Date.now();
    function loop(){
      const now = Date.now();
      let delta = (now - last) / 1000;
      last = now;
      if (!isFinite(delta) || delta <= 0) delta = 0;
      const MAX_DELTA = 1.0;
      if (delta > MAX_DELTA) delta = MAX_DELTA;

      upgrades.forEach(u=>{
        u.progress += u.rate * delta * 100;
        if (u.progress >= 100){
          let completed = Math.floor(u.progress / 100);
          if (completed > 1000000) completed = 1000000;
          u.progress -= completed * 100;
          const incBase = getMultiplierIncrement(u);
          const pMult = 1 + 0.02 * ((u.prestigeLevel && u.prestigeLevel.mult) || 0);
          const ascBonus = 1 + ((u.ascendCount||0) * 0.05);
          u.mult += incBase * pMult * ascBonus * completed;
        }
      });

      const totalMult = upgrades.reduce((acc,u)=>{
        const pBonus = ((u.prestigeLevel && u.prestigeLevel.mult) || 0) * 0.02;
        const ascBonus = (u.ascendCount || 0) * 0.05;
        return acc * (1 + u.mult + pBonus + ascBonus);
      },1) * prestigeMult;

      money += baseIncome * totalMult * delta;

      updateUI();

      if (Date.now() % 5000 < 40) saveGame();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ---------- wiring ----------
    document.getElementById('globalPrestigeBtn').addEventListener('click', ()=> doGlobalPrestige(false));
    window.addEventListener('beforeunload', ()=> saveGame());

    // URL debug
    const params = new URLSearchParams(location.search);
    if (params.get('money')) {
      const m = Number(params.get('money'));
      money = isFinite(m) ? m : Number(params.get('money'));
      updateUI(true);
    }
    if (params.get('forceGlobal') === '1') setTimeout(()=> doGlobalPrestige(true), 200);

  } catch(err){
    showError(err && err.message ? err.message : String(err));
  }
})();
</script>
</body>
</html>
